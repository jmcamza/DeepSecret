# R script to download selected samples
# Copy code and run on a local machine to initiate download

library("rhdf5")    # can be installed using Bioconductor

destination_file = "human_matrix_v10.h5"
extracted_expression_file = "T47D_expression_matrix.tsv"
url = "https://s3.amazonaws.com/mssm-seq-matrix/human_matrix_v10.h5"

# Check if gene expression file was already downloaded, if not in current directory download file form repository
if(!file.exists(destination_file)){
    print("Downloading compressed gene expression matrix.")
    download.file(url, destination_file, quiet = FALSE, mode = 'wb')
}

# Selected samples to be extracted
samp = c("GSM1669206","GSM1969200","GSM1669188","GSM1669197","GSM1669198","GSM1669196","GSM1669184","GSM1669193","GSM1669202","GSM1969197","GSM1669192","GSM1669205","GSM1669185","GSM1669200","GSM1669203","GSM1669191","GSM1669190","GSM1669207","GSM1669201","GSM1943698","GSM1669189","GSM1669194","GSM1943699","GSM1669187","GSM1669195","GSM1669186","GSM1969199","GSM1943700","GSM1669204","GSM1969198","GSM1969196",
"GSM1943701","GSM1969195","GSM1669199","GSM2242134","GSM2242133","GSM2171428","GSM2171429","GSM2171427","GSM2392598","GSM2392601","GSM2392597","GSM2392602","GSM2392589","GSM2392599","GSM2392584","GSM2392582","GSM2392594","GSM2392603","GSM2392590","GSM2392591","GSM2392586","GSM2392585","GSM2392587","GSM2392600","GSM2392583","GSM2392593","GSM2392592","GSM2392588","GSM2392595","GSM2392604",
"GSM2392596","GSM2392605","GSM2198070","GSM2198071","GSM2198072","GSM2198073","GSM2198074","GSM2198075","GSM2198076","GSM2644615","GSM2644616","GSM2644617","GSM2644618","GSM2644619","GSM2644620","GSM2644621","GSM2644622","GSM2644623","GSM2644624","GSM2644625","GSM2644626","GSM2644627","GSM2644628","GSM2644629","GSM2644630","GSM2644631","GSM2644632","GSM2644633","GSM2644634","GSM2644635",
"GSM2644636","GSM2644637","GSM2644638","GSM2644639","GSM2644640","GSM2644641","GSM2644642","GSM2644643","GSM2644644","GSM1939615","GSM1939616","GSM1939617","GSM1939618","GSM1939619","GSM1939620","GSM2131183","GSM2131184","GSM2131185","GSM2131186","GSM2476739","GSM2476740","GSM2476741","GSM2476742","GSM2476743","GSM2476744","GSM2476745","GSM2476746","GSM2476747","GSM2476748","GSM2476749",
"GSM2476750","GSM2476751","GSM2476752","GSM2476753","GSM2476754","GSM2476755","GSM2476756","GSM2648116","GSM2648117","GSM2648118","GSM2648119","GSM2648120","GSM2648121","GSM2648122","GSM2648123","GSM2648124","GSM2648125","GSM2648126","GSM2648127","GSM2648128","GSM2648129","GSM2648130","GSM2648131","GSM2648132","GSM2741453","GSM2741454","GSM2741455","GSM2741456","GSM2741457","GSM2741458",
"GSM2741459","GSM2741460","GSM2741461","GSM2741462","GSM2741463","GSM2741464","GSM3017118","GSM2677909","GSM2677914","GSM2859405","GSM2859406","GSM2859407","GSM2859408","GSM2859409","GSM2859410","GSM2862206","GSM2862207","GSM2862208","GSM2862209","GSM2683268","GSM2683269","GSM3329993","GSM2895202","GSM2895203","GSM2895204","GSM2895205","GSM2895206","GSM2895207","GSM2895220","GSM2895221",
"GSM2895222","GSM3319533","GSM3319534","GSM3308148","GSM3308149","GSM3308150","GSM3308151","GSM3308152","GSM3308153","GSM2828281","GSM2828282","GSM2828283","GSM2828284","GSM2828285","GSM2828286","GSM2828287","GSM2828288","GSM2828289","GSM2828290","GSM2828291","GSM2828292","GSM3044578","GSM3044579","GSM3044580","GSM3044581","GSM3044582","GSM3044583","GSM3044584","GSM3044585","GSM3417110",
"GSM3417111","GSM3417112","GSM3486938","GSM3486939","GSM3486940","GSM3486941","GSM3486942","GSM3486943","GSM3486944","GSM3486945","GSM2633653","GSM2633654","GSM2633655","GSM2633656","GSM2633657","GSM2633658","GSM2633659","GSM2633660","GSM2633701","GSM2633702","GSM2633703","GSM2633704","GSM2633705","GSM2633706","GSM2633707","GSM2633708","GSM3395085","GSM3395086","GSM3395087","GSM3395088",
"GSM3395089","GSM3395090","GSM3395091","GSM3395092","GSM3395093","GSM3395094","GSM3395095","GSM3395096","GSM3395097","GSM3395098","GSM3395099","GSM3395102","GSM3395104","GSM3395106","GSM3395084","GSM3395100","GSM3395101","GSM3395103","GSM3395105","GSM3395107","GSM3660965","GSM3660966","GSM3660967","GSM3660968","GSM3660969","GSM3660970","GSM3660971","GSM2666981","GSM2666982","GSM2666983",
"GSM3375815","GSM3375816","GSM3375817","GSM3375818","GSM3375819","GSM3427403","GSM3427404","GSM3427405","GSM3427406","GSM3427407","GSM3427408","GSM3587645","GSM3587646","GSM3587647","GSM3587648","GSM3587649","GSM3587650","GSM3587651","GSM3587652","GSM3587653","GSM3587654","GSM3587655","GSM3587656","GSM3587689","GSM3587690","GSM3587691","GSM3587692","GSM3587693","GSM3587694","GSM3587695",
"GSM3587696","GSM3587697","GSM3587698","GSM3587699","GSM3587700","GSM3587701","GSM3587702","GSM3587703","GSM3587704","GSM3587705","GSM3587706","GSM3587707","GSM3587708","GSM3587709","GSM3587710","GSM3587711","GSM3587712","GSM3587713","GSM3587714","GSM3587715","GSM3587716","GSM3587717","GSM3587718","GSM3587719","GSM3587720","GSM3595502","GSM3595503","GSM3595504","GSM3595505","GSM3595506",
"GSM3595507","GSM3595508","GSM3595509","GSM3595510","GSM3595511","GSM3595512","GSM3595513","GSM3595514","GSM3595515","GSM3595516","GSM3595517","GSM3595518","GSM3595519","GSM3746300","GSM3746301","GSM3746302","GSM3746303","GSM3746304","GSM3746305","GSM3938636","GSM3938637","GSM3938638","GSM3938639","GSM3938640","GSM3938641","GSM3938642","GSM3938643","GSM3938644","GSM3938645","GSM3938646",
"GSM3938647","GSM4081982","GSM4081983","GSM4081984","GSM4081985","GSM4081986","GSM4081987","GSM4081988","GSM4081989","GSM4081990","GSM4081991","GSM4081992","GSM4081993","GSM4081994","GSM4081995","GSM4081997","GSM4081998","GSM4081999","GSM4082000","GSM4082001","GSM4082002","GSM4082003","GSM4082004","GSM4082005","GSM4082006","GSM4082007","GSM4082008","GSM4082009","GSM4082010","GSM4082011",
"GSM4082012","GSM4082013","GSM4448634","GSM4448635","GSM4448636","GSM4551105","GSM4551106","GSM4551107","GSM4551108","GSM4551109","GSM4551110","GSM4551111","GSM4551112","GSM4551113","GSM4551114","GSM4551115","GSM4551116","GSM4556391","GSM4556392","GSM4556393","GSM4556394","GSM4556395","GSM4556396","GSM4556397","GSM4556398","GSM4556399","GSM4556400","GSM4556401","GSM4556402","GSM4577493",
"GSM4577494","GSM4577495","GSM4577496","GSM2666980","GSM2666984","GSM3375820","GSM4081996","GSM4211215","GSM4211216","GSM4211217","GSM4211218","GSM4211221","GSM4211222","GSM4211223","GSM4221944","GSM4221945","GSM4287017","GSM4287018","GSM4287019","GSM4287020","GSM4287021","GSM4287022","GSM4287023","GSM4287024","GSM4287025","GSM4340146","GSM4340147","GSM4340148","GSM4953951","GSM4953952",
"GSM3395083","GSM3565371","GSM3565372","GSM3565373","GSM3565392","GSM3565393","GSM3565394","GSM3565413","GSM3565414","GSM3565415","GSM3565434","GSM3565435","GSM3565436","GSM3565455","GSM3565456","GSM3565457","GSM3565476","GSM3565477","GSM3565478","GSM3565497","GSM3565498","GSM3565499","GSM3565518","GSM3565519","GSM3565520","GSM3565539","GSM3565540","GSM3565541","GSM3565560","GSM3565561",
"GSM3565562","GSM3565581","GSM3565582","GSM3565583","GSM3565602","GSM3565603","GSM3565604","GSM3565623","GSM3565624","GSM3565625","GSM3565644","GSM3565646","GSM3565665","GSM3565666","GSM3565667","GSM3565685","GSM3565686","GSM3565687","GSM4117416","GSM4117418","GSM5533967","GSM5533968","GSM5533969","GSM5533970","")

# Retrieve information from compressed data
samples = h5read(destination_file, "meta/samples/geo_accession")
genes = h5read(destination_file, "meta/genes/genes")

# Identify columns to be extracted
sample_locations = which(samples %in% samp)

# extract gene expression from compressed data
expression = t(h5read(destination_file, "data/expression", index=list(sample_locations, 1:length(genes))))
H5close()
rownames(expression) = genes
colnames(expression) = samples[sample_locations]

# Print file
write.table(expression, file=extracted_expression_file, sep="\t", quote=FALSE, col.names=NA)
print(paste0("Expression file was created at ", getwd(), "/", extracted_expression_file))

