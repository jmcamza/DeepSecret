# R script to download selected samples
# Copy code and run on a local machine to initiate download

library("rhdf5")    # can be installed using Bioconductor

destination_file = "human_matrix_v10.h5"
extracted_expression_file = "ES2_expression_matrix.tsv"
url = "https://s3.amazonaws.com/mssm-seq-matrix/human_matrix_v10.h5"

# Check if gene expression file was already downloaded, if not in current directory download file form repository
if(!file.exists(destination_file)){
    print("Downloading compressed gene expression matrix.")
    download.file(url, destination_file, quiet = FALSE, mode = 'wb')
}

# Selected samples to be extracted
samp = c("GSM2151895","GSM1571101","GSM1571067","GSM1571110","GSM1571120","GSM1571100","GSM1571121","GSM1571105","GSM1571060","GSM1571065","GSM1571114","GSM1571058","GSM1571084","GSM1571095","GSM1571117","GSM1571106","GSM1571107","GSM1571085","GSM1571056","GSM1571073","GSM1571082","GSM1571089","GSM1571087","GSM1571108","GSM1571111","GSM1571075","GSM1571061","GSM1571088","GSM1571074","GSM1571071","GSM1571097",
"GSM1571094","GSM1571066","GSM1571062","GSM1571063","GSM1571124","GSM1571119","GSM1571125","GSM1571072","GSM1571090","GSM1571076","GSM1571086","GSM1571070","GSM1571109","GSM1571112","GSM1571123","GSM1571098","GSM1571096","GSM1571077","GSM1571057","GSM1571115","GSM1571068","GSM1571079","GSM1571059","GSM1571092","GSM1571091","GSM1571122","GSM1571118","GSM1571113","GSM1571080","GSM1571099",
"GSM1571093","GSM1571069","GSM1571081","GSM1571055","GSM1571078","GSM1571103","GSM1571102","GSM1571104","GSM1571083","GSM1571064","GSM1571116","GSM2344966","GSM2537118","GSM2537119","GSM2537120","GSM2537124","GSM2537125","GSM2537126","GSM2537130","GSM2537131","GSM2537132","GSM2537136","GSM2537137","GSM2537138","GSM2151891","GSM2151892","GSM2893714","GSM2893715","GSM2893716","GSM2893717",
"GSM3058945","GSM2462751","GSM2462752","GSM2462753","GSM2462754","GSM2348326","GSM2348327","GSM2348329","GSM2348330","GSM2348332","GSM2348333","GSM2348335","GSM2348336","GSM2348337","GSM2348339","GSM2348340","GSM2348341","GSM2348342","GSM2348343","GSM2348344","GSM2348345","GSM2348347","GSM2348348","GSM2348351","GSM2348352","GSM2348355","GSM2348356","GSM2348357","GSM2348361","GSM2348362",
"GSM2348363","GSM2348365","GSM2348366","GSM2348368","GSM2348369","GSM2348370","GSM2348371","GSM2348372","GSM2348373","GSM2348374","GSM2348375","GSM2348376","GSM2348379","GSM2348380","GSM2348381","GSM2348382","GSM2348384","GSM2348386","GSM2348388","GSM2348389","GSM2348390","GSM2348392","GSM2348393","GSM2348394","GSM2348395","GSM2348397","GSM2348398","GSM2348399","GSM2348400","GSM2348402",
"GSM2348403","GSM2348404","GSM2348405","GSM2348407","GSM2348408","GSM2348409","GSM2348410","GSM2348411","GSM2348412","GSM2348414","GSM2348415","GSM2348416","GSM2348419","GSM2348420","GSM2348421","GSM2348422","GSM2348423","GSM2348425","GSM2348426","GSM2348427","GSM2348428","GSM2348430","GSM2348431","GSM2348432","GSM2348434","GSM2348435","GSM2348437","GSM2348438","GSM2348440","GSM2348441",
"GSM2348442","GSM2348443","GSM2348445","GSM2348446","GSM2348447","GSM2348448","GSM2348449","GSM2348450","GSM2348451","GSM2348452","GSM2348453","GSM2348454","GSM2348455","GSM2348456","GSM2348457","GSM2348458","GSM2348459","GSM2348460","GSM2348461","GSM2348462","GSM2348463","GSM2348464","GSM2348465","GSM2348466","GSM2348467","GSM2348468","GSM2348469","GSM2348470","GSM2348471","GSM2348472",
"GSM2348473","GSM2348474","GSM2348475","GSM2348476","GSM2348478","GSM2348479","GSM2348480","GSM2348481","GSM2348482","GSM2348483","GSM2348484","GSM2348485","GSM2348486","GSM2348487","GSM2348488","GSM2348489","GSM2348490","GSM2348492","GSM2348493","GSM2348494","GSM2348495","GSM2348496","GSM2348497","GSM2348498","GSM2348499","GSM2348500","GSM2348501","GSM2348502","GSM2348503","GSM2348504",
"GSM2348507","GSM2348509","GSM2348510","GSM2348511","GSM2348514","GSM2348515","GSM2348517","GSM2348518","GSM2348520","GSM2348521","GSM2348522","GSM2348523","GSM2348524","GSM2348525","GSM2348526","GSM2348527","GSM2348528","GSM2348529","GSM2348530","GSM2348531","GSM2348532","GSM2348535","GSM2348536","GSM2348537","GSM2348538","GSM2348539","GSM2348540","GSM2348541","GSM2348542","GSM2348543",
"GSM2348544","GSM2348545","GSM2348546","GSM2348547","GSM2348548","GSM2348549","GSM2348550","GSM2348551","GSM2348553","GSM2348554","GSM2348555","GSM2348557","GSM2348558","GSM2348559","GSM2348560","GSM2348561","GSM2348562","GSM2348564","GSM2348565","GSM2348566","GSM2348569","GSM2348571","GSM2348572","GSM2348573","GSM2348574","GSM2348578","GSM2348579","GSM2348580","GSM2348581","GSM2348582",
"GSM2348583","GSM2348584","GSM2348585","GSM2348586","GSM2348587","GSM2348588","GSM2348589","GSM2348590","GSM2348591","GSM2348592","GSM2348593","GSM2348594","GSM2348595","GSM2348596","GSM2348599","GSM2348601","GSM2348602","GSM2348603","GSM2348604","GSM2348605","GSM2348606","GSM2348607","GSM2348608","GSM2348609","GSM2348610","GSM2348612","GSM2348613","GSM2348614","GSM2348615","GSM2348616",
"GSM2348617","GSM2348618","GSM2348619","GSM2348620","GSM2348621","GSM2348622","GSM2348623","GSM2348625","GSM2348626","GSM2348627","GSM2348628","GSM2348629","GSM2348630","GSM2348631","GSM2348632","GSM2348633","GSM2348634","GSM2348635","GSM2348636","GSM2348637","GSM2348638","GSM2348639","GSM2348640","GSM2348641","GSM2348642","GSM2348643","GSM2348644","GSM2348645","GSM2348646","GSM2348647",
"GSM2348648","GSM2348649","GSM2348651","GSM2348652","GSM2348653","GSM2348654","GSM2348655","GSM2348656","GSM2348657","GSM2348658","GSM2348659","GSM2348660","GSM2348661","GSM2348662","GSM2348663","GSM2348664","GSM2348665","GSM2348666","GSM2348667","GSM2348668","GSM2348669","GSM2348670","GSM2348671","GSM2348672","GSM2348673","GSM2348674","GSM2348675","GSM2348676","GSM2348677","GSM2348678",
"GSM2348679","GSM2348680","GSM2348681","GSM2348682","GSM2348683","GSM2348684","GSM2348685","GSM2348686","GSM2348688","GSM2348690","GSM2348691","GSM2348692","GSM2348693","GSM2348694","GSM2348695","GSM2348696","GSM2348697","GSM2348698","GSM2348699","GSM2348701","GSM2348702","GSM2348703","GSM2348705","GSM2348706","GSM2348707","GSM2348708","GSM2348710","GSM2348711","GSM2348712","GSM2348714",
"GSM2348715","GSM2348716","GSM2348718","GSM2348719","GSM2348720","GSM2348721","GSM2348722","GSM2348723","GSM2348724","GSM2348726","GSM2348727","GSM2348728","GSM2348729","GSM2348730","GSM2348731","GSM2348732","GSM2348733","GSM2348734","GSM2348735","GSM2348736","GSM2348737","GSM2348738","GSM2348739","GSM2348740","GSM2348741","GSM2348742","GSM2348743","GSM2348744","GSM2348745","GSM2348746",
"GSM2348747","GSM2348748","GSM2348749","GSM2348750","GSM2348751","GSM2348752","GSM2348753","GSM2348754","GSM2348756","GSM2348757","GSM2348758","GSM2348759","GSM2348760","GSM2348761","GSM2348762","GSM2348763","GSM2348764","GSM2348766","GSM2348767","GSM2348768","GSM2348769","GSM2348770","GSM2348771","GSM2348772","GSM2348773","GSM2348774","GSM2348775","GSM2348776","GSM2348777","GSM2348778",
"GSM2348779","GSM2348780","GSM2348781","GSM2348782","GSM2348783","GSM2348784","GSM2348785","GSM2348786","GSM2348787","GSM2348788","GSM2348789","GSM2348790","GSM2348791","GSM2348792","GSM2348793","GSM2348794","GSM2348795","GSM2348796","GSM2348797","GSM2348798","GSM2348799","GSM2348800","GSM2348801","GSM2348802","GSM2348803","GSM2348804","GSM2348805","GSM2348806","GSM2348807","GSM2348808",
"GSM2348809","GSM2348810","GSM2348811","GSM2348812","GSM2348813","GSM2348814","GSM2348815","GSM2348816","GSM2348817","GSM2348818","GSM2348819","GSM2348820","GSM2348821","GSM2348822","GSM2348823","GSM2348824","GSM2348825","GSM2348826","GSM2944130","GSM2944131","GSM2944132","GSM2944133","GSM2944134","GSM2944135","GSM2944136","GSM2944137","GSM3059098","GSM3161875","GSM3161876","GSM3161877",
"GSM3161878","GSM3161879","GSM3161880","GSM3161881","GSM3161882","GSM3161883","GSM3161884","GSM3161885","GSM3161886","GSM3161887","GSM2611790","GSM2611791","GSM2611792","GSM2611793","GSM2611794","GSM2611795","GSM3139687","GSM3818014","GSM3818015","GSM3818016","GSM3452828","GSM3452829","GSM3452830","GSM3452831","GSM3452832","GSM3452833","GSM3452834","GSM3452835","GSM3452836","GSM3452837",
"GSM3452838","GSM3452839","GSM4477916","GSM4477917","GSM4477918","GSM4477919","GSM4477920","GSM4477921","GSM4477922","GSM4477923","GSM4477924","GSM4477925","GSM4477926","GSM4477927","GSM4477928","GSM4477929","GSM4477930","GSM4477931","GSM4221267","GSM4221268","GSM4221269","GSM4221270","GSM4221271","GSM4221272","GSM4221273","GSM4221274","GSM4221275","GSM4221276","GSM4221277","GSM4221278",
"GSM4221279","GSM4221280","GSM4221281","GSM4221282","GSM4557108","GSM4557109","GSM4557110","GSM4557111","GSM4557112","GSM4568142","GSM4798079","GSM4798080","GSM4798081","GSM4798082","GSM2610610","GSM2610611","GSM2743714","GSM2743715","GSM3164809","GSM3164810","GSM4622967","GSM4622968","GSM4622970","GSM4622971","GSM4622972","GSM4622973","GSM4622974","GSM4622975","GSM4650132","GSM4650133",
"GSM4650134","GSM4650135","GSM4650136","GSM4650137","GSM4873575","GSM4873576","GSM4873577","GSM4873578","GSM4887774","GSM4887775","GSM4887776","GSM4887777","GSM4887778","GSM4887779","GSM5315941","GSM5315942","GSM5315943","GSM5315944","GSM5315945","GSM5315946","GSM5315947","GSM5315948","GSM5315949","GSM5360305","GSM5360306","GSM5360307","GSM5360308","GSM5360309","GSM5360312","GSM5360313",
"GSM5360314","GSM5360315","GSM5360316","GSM5360317","GSM5360318","GSM5360319","")

# Retrieve information from compressed data
samples = h5read(destination_file, "meta/samples/geo_accession")
genes = h5read(destination_file, "meta/genes/genes")

# Identify columns to be extracted
sample_locations = which(samples %in% samp)

# extract gene expression from compressed data
expression = t(h5read(destination_file, "data/expression", index=list(sample_locations, 1:length(genes))))
H5close()
rownames(expression) = genes
colnames(expression) = samples[sample_locations]

# Print file
write.table(expression, file=extracted_expression_file, sep="\t", quote=FALSE, col.names=NA)
print(paste0("Expression file was created at ", getwd(), "/", extracted_expression_file))

