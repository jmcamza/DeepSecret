# R script to download selected samples
# Copy code and run on a local machine to initiate download

library("rhdf5")    # can be installed using Bioconductor

destination_file = "human_matrix_v10.h5"
extracted_expression_file = "HUVEC_expression_matrix.tsv"
url = "https://s3.amazonaws.com/mssm-seq-matrix/human_matrix_v10.h5"

# Check if gene expression file was already downloaded, if not in current directory download file form repository
if(!file.exists(destination_file)){
    print("Downloading compressed gene expression matrix.")
    download.file(url, destination_file, quiet = FALSE, mode = 'wb')
}

# Selected samples to be extracted
samp = c("GSM1071305","GSM1131341","GSM1131343","GSM1131340","GSM1131342","GSM1131338","GSM990769","GSM1154036","GSM1154035","GSM1076106","GSM1071304","GSM1131339","GSM990770","GSM2037125","GSM1386275","GSM2054981","GSM1724088","GSM2037126","GSM2054983","GSM1386281","GSM2306256","GSM2306251","GSM2037128","GSM2306252","GSM1386282","GSM1386279","GSM2306254","GSM2037123","GSM1558416","GSM2306253","GSM2054986",
"GSM2037124","GSM2054987","GSM1724089","GSM1327344","GSM2306257","GSM2054985","GSM1724091","GSM1724087","GSM2054984","GSM2037129","GSM1724090","GSM2306250","GSM2306258","GSM2306260","GSM2306249","GSM2306255","GSM2054982","GSM1724092","GSM1386280","GSM2037122","GSM2054980","GSM1828766","GSM1659553","GSM1828771","GSM1828765","GSM1828770","GSM2232891","GSM1828761","GSM1828762","GSM1828769",
"GSM1828760","GSM2232892","GSM1830137","GSM1659552","GSM1828767","GSM1828764","GSM1830134","GSM1659554","GSM1830135","GSM1828768","GSM2232890","GSM1828763","GSM1830136","GSM2037127","GSM2283975","GSM2283974","GSM2283973","GSM2306259","GSM2170574","GSM2170571","GSM2170576","GSM2170577","GSM2170575","GSM2170580","GSM2170572","GSM2170541","GSM2170579","GSM2170578","GSM2170581","GSM2170573",
"GSM2170582","GSM2170562","GSM2170536","GSM2170516","GSM2170539","GSM2170535","GSM2170519","GSM2170523","GSM2170526","GSM2170515","GSM2170554","GSM2170533","GSM2170553","GSM2170513","GSM2170531","GSM2170565","GSM2170529","GSM2170530","GSM2170558","GSM2170561","GSM2170543","GSM2170547","GSM2170564","GSM2170509","GSM2170525","GSM2170556","GSM2170534","GSM2170528","GSM2170527","GSM2170518",
"GSM2170538","GSM2170537","GSM2170563","GSM2170548","GSM2170521","GSM2170520","GSM2170522","GSM2170517","GSM2170567","GSM2170560","GSM2170557","GSM2170514","GSM2170549","GSM2170524","GSM2170540","GSM2170566","GSM2170550","GSM2170552","GSM2170511","GSM2170512","GSM2170542","GSM2170510","GSM2170568","GSM2170532","GSM2170555","GSM2170559","GSM2170551","GSM2170545","GSM2170546","GSM2170569",
"GSM2170544","GSM2170570","GSM2262382","GSM2262384","GSM2262383","GSM2432100","GSM2432101","GSM2453575","GSM2453574","GSM2453562","GSM2453563","GSM2453573","GSM2453543","GSM2453536","GSM2453555","GSM2453572","GSM2453564","GSM2453571","GSM2453549","GSM2453565","GSM2453566","GSM2778981","GSM2778982","GSM2778983","GSM2778984","GSM2778985","GSM2778986","GSM2778987","GSM2778988","GSM2778989",
"GSM2778990","GSM2778991","GSM2778992","GSM2778993","GSM2778994","GSM2778995","GSM2778996","GSM2778997","GSM2778998","GSM2778999","GSM2779000","GSM2779001","GSM2779002","GSM2779003","GSM2779004","GSM2779005","GSM2779006","GSM2779007","GSM2779008","GSM2779009","GSM2779010","GSM2779011","GSM2779012","GSM2779013","GSM2779014","GSM2779015","GSM2779016","GSM2779017","GSM2779018","GSM2779019",
"GSM2779020","GSM2779021","GSM2779022","GSM2284642","GSM2284643","GSM2284644","GSM2284645","GSM2284646","GSM2284647","GSM2284648","GSM2284649","GSM2284650","GSM2333475","GSM2333476","GSM2333477","GSM2333478","GSM2333479","GSM2333480","GSM2333481","GSM2333482","GSM2333483","GSM2333484","GSM2333698","GSM2333699","GSM2333700","GSM2333701","GSM2333702","GSM2333703","GSM2333704","GSM2333705",
"GSM2333706","GSM2333707","GSM2390691","GSM2390692","GSM2390693","GSM2390694","GSM2390695","GSM2390696","GSM2390697","GSM2390698","GSM2390699","GSM2390700","GSM2390701","GSM2390702","GSM2390703","GSM2390704","GSM2477206","GSM2477207","GSM2782540","GSM2782541","GSM2782542","GSM2782543","GSM2782544","GSM2782545","GSM2782546","GSM2782547","GSM2252986","GSM2252987","GSM2252988","GSM2252989",
"GSM2252990","GSM2252991","GSM2252992","GSM2252993","GSM2252994","GSM2252995","GSM2252996","GSM2252997","GSM2418719","GSM2418720","GSM2418721","GSM2418722","GSM2652138","GSM2652139","GSM2652140","GSM2652141","GSM2652142","GSM2652143","GSM2982037","GSM2982038","GSM2723761","GSM2723762","GSM2805206","GSM2805212","GSM2805213","GSM2805214","GSM2805215","GSM2805216","GSM2805217","GSM2805218",
"GSM2805219","GSM2805220","GSM2805221","GSM2390683","GSM2390684","GSM2390685","GSM2390686","GSM2390687","GSM2390688","GSM2390689","GSM2390690","GSM3026829","GSM3026830","GSM3026831","GSM3026832","GSM3026833","GSM3026834","GSM2743856","GSM2743857","GSM2743858","GSM2743859","GSM2743860","GSM2743861","GSM2743862","GSM2743863","GSM2743864","GSM3209197","GSM3209198","GSM3209199","GSM3209200",
"GSM3209201","GSM3209202","GSM3209203","GSM3209204","GSM3209205","GSM3209206","GSM3209207","GSM3209208","GSM3332200","GSM3332201","GSM3332202","GSM3332203","GSM3332204","GSM3332205","GSM3332206","GSM3332207","GSM3378773","GSM3378774","GSM3378775","GSM3378776","GSM3378777","GSM3378778","GSM3378779","GSM3378780","GSM3467282","GSM3467283","GSM3467284","GSM3467285","GSM3467286","GSM3467287",
"GSM3494324","GSM3494325","GSM3494326","GSM3494327","GSM3494328","GSM3494329","GSM3494330","GSM3494331","GSM3494332","GSM3494333","GSM3332060","GSM3332061","GSM3332062","GSM3332063","GSM3752668","GSM3752669","GSM3752670","GSM3752671","GSM3752672","GSM3752673","GSM3752674","GSM3752675","GSM3752676","GSM3752677","GSM3752678","GSM3752679","GSM3752680","GSM3752681","GSM3752682","GSM3752683",
"GSM3752684","GSM3752685","GSM3752686","GSM3752687","GSM3752688","GSM3752689","GSM3752690","GSM3752691","GSM3752692","GSM3752693","GSM3752694","GSM3752695","GSM3752696","GSM3752697","GSM3752698","GSM3752699","GSM3752700","GSM3752701","GSM3752702","GSM3752703","GSM3752704","GSM3358163","GSM3358164","GSM3358165","GSM3358166","GSM3358167","GSM3358168","GSM3358169","GSM3358170","GSM3955776",
"GSM3955777","GSM3955778","GSM3955779","GSM3978705","GSM3978706","GSM3978707","GSM3978708","GSM3978709","GSM3978710","GSM3978711","GSM3978712","GSM3978713","GSM3978714","GSM3978715","GSM3978716","GSM3978717","GSM3978718","GSM3446029","GSM3446030","GSM3446031","GSM3446032","GSM4120183","GSM4120184","GSM3231493","GSM3231494","GSM3231495","GSM3231496","GSM3231497","GSM3231498","GSM3231499",
"GSM3231500","GSM3231501","GSM3231502","GSM3231503","GSM3231504","GSM3231505","GSM3231506","GSM3231507","GSM3231508","GSM3231509","GSM3231510","GSM3231511","GSM3231512","GSM3231513","GSM3231514","GSM3231515","GSM3231516","GSM3231517","GSM3231518","GSM3231519","GSM3601218","GSM3601219","GSM3601220","GSM3601221","GSM3601222","GSM3601223","GSM3601224","GSM3601225","GSM3601226","GSM4080604",
"GSM4080606","GSM4080607","GSM4080609","GSM4195641","GSM4195642","GSM4195643","GSM4195644","GSM4195645","GSM4195646","GSM2123857","GSM2123858","GSM2982735","GSM2982736","GSM2982737","GSM2982738","GSM2982739","GSM2982740","GSM3056605","GSM3056606","GSM3056607","GSM3056608","GSM3207732","GSM3207733","GSM3207734","GSM3207735","GSM3207736","GSM3207737","GSM3207738","GSM3207739","GSM3207740",
"GSM3361947","GSM3361948","GSM3361949","GSM3409451","GSM3409452","GSM3409453","GSM3409454","GSM3409455","GSM3409456","GSM3409457","GSM3409458","GSM3409459","GSM3409460","GSM3409461","GSM3611783","GSM3611784","GSM3611785","GSM3611786","GSM3611787","GSM3611788","GSM3634820","GSM3634821","GSM3634822","GSM3761201","GSM3761202","GSM3761203","GSM3761204","GSM3761205","GSM3761206","GSM3761207",
"GSM3761208","GSM3761209","GSM3761210","GSM3761211","GSM3761212","GSM3761213","GSM3761214","GSM3761215","GSM3761216","GSM3761217","GSM3761222","GSM3761223","GSM3761224","GSM3761225","GSM3761226","GSM3761227","GSM3761228","GSM3761229","GSM3761240","GSM3761241","GSM3761242","GSM3761243","GSM3761244","GSM3899112","GSM3899113","GSM3899114","GSM3899115","GSM4034765","GSM4034766","GSM4079082",
"GSM4079083","GSM4079084","GSM4079085","GSM4079086","GSM4079087","GSM4079088","GSM4079089","GSM4079090","GSM4079091","GSM4079092","GSM4079093","GSM4079094","GSM4079095","GSM4079096","GSM4079592","GSM4079593","GSM4079594","GSM4079595","GSM4079596","GSM4079597","GSM4079598","GSM4079599","GSM4079600","GSM4105698","GSM4142386","GSM4142387","GSM4142388","GSM4142389","GSM4142390","GSM4142391",
"GSM4142392","GSM4142393","GSM4142394","GSM4144589","GSM4144590","GSM4144591","GSM4144592","GSM4144593","GSM4144594","GSM4195937","GSM4195938","GSM4195939","GSM4195940","GSM4195941","GSM4195942","GSM4247461","GSM4247462","GSM4247463","GSM4247464","GSM4247465","GSM4247466","GSM4247467","GSM4247468","GSM4247469","GSM4247470","GSM4247471","GSM4247472","GSM4282392","GSM4282393","GSM4426217",
"GSM4426218","GSM4426219","GSM4426220","GSM4432792","GSM4432793","GSM4432794","GSM4432795","GSM4432796","GSM4432797","GSM4432798","GSM4432799","GSM4487131","GSM4487134","GSM4518601","GSM4518602","GSM4579140","GSM4592369","GSM4592370","GSM4592371","GSM4592372","GSM4592373","GSM4592374","GSM4592375","GSM4592376","GSM4592377","GSM4592378","GSM4592379","GSM4592380","GSM4592381","GSM4592382",
"GSM4592383","GSM4592384","GSM4592385","GSM4592386","GSM4592387","GSM4592388","GSM4673218","GSM4673219","GSM4673220","GSM4673221","GSM4673222","GSM4673223","GSM4673224","GSM4673225","GSM4673226","GSM4673227","GSM4673228","GSM4673229","GSM4704578","GSM4704579","GSM4254166","GSM4254167","GSM4983446","GSM4983448","GSM4983449","GSM4983451","GSM3227987","GSM3227988","GSM3227989","GSM3227990",
"GSM3227991","GSM3227992","GSM3227993","GSM3227994","GSM3227995","GSM3227996","GSM3227998","GSM3348151","GSM3348153","GSM3348154","GSM3348155","GSM3348156","GSM3348157","GSM3348158","GSM3348159","GSM3348160","GSM3348161","GSM3348162","GSM3348164","GSM3348165","GSM3348166","GSM3348167","GSM3348168","GSM3681470","GSM3681471","GSM3681472","GSM3681473","GSM3681474","GSM3681475","GSM3681476",
"GSM3681477","GSM3681478","GSM3681479","GSM3681480","GSM3681481","GSM3681482","GSM3681483","GSM3681484","GSM3734139","GSM3734141","GSM3734142","GSM3734143","GSM3980174","GSM3980175","GSM3980176","GSM3980177","GSM3980178","GSM3980180","GSM3980181","GSM3980182","GSM3980184","GSM3980185","GSM3980186","GSM3980187","GSM3980188","GSM3980189","GSM3980190","GSM3980191","GSM4067393","GSM4067395",
"GSM4067396","GSM4067397","GSM4067399","GSM4067400","GSM4067401","GSM4067402","GSM4067404","GSM4413060","GSM4413062","GSM4413063","GSM4413064","GSM4413066","GSM4567119","GSM4567120","GSM4567121","GSM4592484","GSM4592485","GSM4592486","GSM4592487","GSM4680313","GSM4680314","GSM4680315","GSM4680316","GSM4698479","GSM4698481","GSM4698482","GSM4698485","GSM4915116","GSM4915117","GSM4915118",
"GSM4915119","GSM4915120","GSM4915121","GSM4975732","GSM4975737","GSM4996467","GSM5009028","GSM5009030","GSM5009031","GSM5009032","GSM5009033","GSM5009035","GSM5009036","GSM5009037","GSM5009038","GSM5009039","GSM5090416","GSM5090418","GSM5090420","GSM5221062","GSM5221063","GSM5221065","GSM5221066","GSM5221068","GSM5221069","GSM5221071","GSM5221072","GSM5221073","GSM5244093","GSM5244094",
"GSM5244095","GSM5244096","GSM5244097","GSM5244098","GSM5244099","GSM5244100","GSM5244101","GSM5244102","GSM5244103","GSM5244104","GSM5244106","GSM5244107","GSM5244108","GSM5244109","GSM5244110","GSM5365663","GSM5365665","GSM5365667","GSM5365668","GSM5436052","GSM5436053","GSM5436054","GSM5436055","GSM5436056","GSM5436057","GSM5436059","GSM5436060","GSM5436061","GSM5436062","GSM5436063",
"GSM5470543","GSM5470544","GSM5470545","GSM5470546","GSM5470547","GSM5470548","GSM5577332","GSM5577333","GSM5577334","GSM5577335","GSM5577336","GSM5577337","")

# Retrieve information from compressed data
samples = h5read(destination_file, "meta/samples/geo_accession")
genes = h5read(destination_file, "meta/genes/genes")

# Identify columns to be extracted
sample_locations = which(samples %in% samp)

# extract gene expression from compressed data
expression = t(h5read(destination_file, "data/expression", index=list(sample_locations, 1:length(genes))))
H5close()
rownames(expression) = genes
colnames(expression) = samples[sample_locations]

# Print file
write.table(expression, file=extracted_expression_file, sep="\t", quote=FALSE, col.names=NA)
print(paste0("Expression file was created at ", getwd(), "/", extracted_expression_file))

