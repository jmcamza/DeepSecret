# R script to download selected samples
# Copy code and run on a local machine to initiate download

library("rhdf5")    # can be installed using Bioconductor

destination_file = "human_matrix_v10.h5"
extracted_expression_file = "293F_expression_matrix.tsv"
url = "https://s3.amazonaws.com/mssm-seq-matrix/human_matrix_v10.h5"

# Check if gene expression file was already downloaded, if not in current directory download file form repository
if(!file.exists(destination_file)){
    print("Downloading compressed gene expression matrix.")
    download.file(url, destination_file, quiet = FALSE, mode = 'wb')
}

# Selected samples to be extracted
samp = c("GSM1245900","GSM2011519","GSM2011515","GSM1440611","GSM2011517","GSM2011512","GSM1440619","GSM2011520","GSM1440618","GSM1553198","GSM1440615","GSM1553202","GSM2011522","GSM1382453","GSM2011504","GSM1440614","GSM2011506","GSM1440620","GSM1553206","GSM1440617","GSM2011502","GSM2011508","GSM2011513","GSM2011518","GSM1553201","GSM1553197","GSM1440613","GSM2011507","GSM1440610","GSM1440622","GSM1553204",
"GSM2011523","GSM2011516","GSM1553196","GSM1553200","GSM2011503","GSM2011510","GSM2011505","GSM1553205","GSM1440616","GSM1440612","GSM2011514","GSM2011525","GSM1553203","GSM2011524","GSM1553199","GSM1440621","GSM2011511","GSM2011509","GSM1553195","GSM1631490","GSM1631496","GSM1631497","GSM1631494","GSM1631492","GSM1631491","GSM1631499","GSM1631493","GSM1631495","GSM1631498","GSM2011521",
"GSM2061462","GSM2061452","GSM2061449","GSM2061469","GSM2061457","GSM2061455","GSM2061454","GSM2061451","GSM2061468","GSM2061465","GSM2061467","GSM2061459","GSM2061458","GSM2061461","GSM2061460","GSM2061464","GSM2061466","GSM2061450","GSM2061453","GSM2061456","GSM2061463","GSM2460288","GSM2460286","GSM2460291","GSM2460290","GSM2460287","GSM2098539","GSM2098540","GSM2098541","GSM2300414",
"GSM2300415","GSM2300416","GSM2300417","GSM2300418","GSM2300419","GSM2300420","GSM2300421","GSM2300422","GSM2916063","GSM2916064","GSM2916065","GSM2916066","GSM2916067","GSM2916068","GSM2916069","GSM2916070","GSM2916071","GSM2464321","GSM2464322","GSM2902702","GSM2902703","GSM2902704","GSM2902705","GSM2902706","GSM2902707","GSM2902708","GSM2902709","GSM2902710","GSM2902711","GSM2902712",
"GSM2902713","GSM2902714","GSM2902715","GSM2902716","GSM2902717","GSM2902718","GSM2902719","GSM2902720","GSM2902721","GSM2902722","GSM2492288","GSM2492289","GSM2492290","GSM2492291","GSM2492292","GSM2492293","GSM2492294","GSM2492295","GSM2492296","GSM2492297","GSM2492298","GSM2492299","GSM1568709","GSM1568710","GSM1568711","GSM1568712","GSM3083474","GSM3083475","GSM3083476","GSM3083477",
"GSM3083478","GSM3083479","GSM3083480","GSM3083481","GSM3083482","GSM3083483","GSM3083484","GSM3083485","GSM3083486","GSM3083487","GSM2825322","GSM2825317","GSM2825328","GSM3408735","GSM3408736","GSM3408737","GSM3408738","GSM3408739","GSM3408740","GSM3408741","GSM3408742","GSM3408743","GSM3408744","GSM3408745","GSM3408746","GSM3408747","GSM3408748","GSM3408749","GSM3395914","GSM3395915",
"GSM3395916","GSM3395917","GSM3395918","GSM3395919","GSM3395920","GSM3395921","GSM3395922","GSM3395923","GSM3395924","GSM3395925","GSM3395926","GSM3395927","GSM3576357","GSM3576358","GSM3576359","GSM3576360","GSM3447343","GSM3447344","GSM3447345","GSM3447346","GSM3447347","GSM3447348","GSM3447349","GSM3447350","GSM3447351","GSM3447352","GSM3447353","GSM3447354","GSM3447355","GSM3447356",
"GSM3447357","GSM3447358","GSM3447359","GSM3447360","GSM3447361","GSM3447362","GSM3447363","GSM3447364","GSM3447365","GSM3447366","GSM3447367","GSM3447368","GSM3447369","GSM3447370","GSM3447371","GSM3447372","GSM3447373","GSM3447374","GSM3447375","GSM3447376","GSM3447377","GSM3447378","GSM3563707","GSM3563708","GSM3563709","GSM3563710","GSM4156817","GSM4156818","GSM4156819","GSM4156820",
"GSM4156821","GSM4156822","GSM4156823","GSM4156824","GSM4156825","GSM4156826","GSM4156827","GSM4156828","GSM4156829","GSM4156830","GSM4156831","GSM4156832","GSM4156833","GSM4156834","GSM4156835","GSM4156836","GSM4156837","GSM4156838","GSM4156839","GSM4156840","GSM3977064","GSM3977065","GSM3977066","GSM3977067","GSM4048803","GSM4048804","GSM4048805","GSM4048806","GSM4048807","GSM4048808",
"GSM4048809","GSM4048810","GSM4048811","GSM4048812","GSM4048813","GSM4048814","GSM4426014","GSM4426015","GSM3540261","GSM3540262","GSM3540264","GSM3540266","GSM3540268","GSM3540270","GSM3540271","GSM3540272","GSM3540273","GSM3540274","GSM3540275","GSM3540276","GSM3540277","GSM3540278","GSM3540279","GSM3540280","GSM3540281","GSM3540282","GSM3540283","GSM3540284","GSM3540285","GSM3540286",
"GSM3540287","GSM3540288","GSM4002651","GSM4002652","GSM4002653","GSM4002654","GSM4002655","GSM4002656","GSM4509031","GSM4509032","GSM4509033","GSM4509034","GSM4509035","GSM4509036","GSM4509037","GSM4509038","GSM4830599","GSM4830600","GSM4830601","GSM4830602","GSM4695835","GSM4695836","GSM4695838","GSM4695839","GSM4695840","GSM4695841","GSM4695842","GSM5011799","GSM5011806","GSM5103036",
"GSM5103037","GSM5103039","")

# Retrieve information from compressed data
samples = h5read(destination_file, "meta/samples/geo_accession")
genes = h5read(destination_file, "meta/genes/genes")

# Identify columns to be extracted
sample_locations = which(samples %in% samp)

# extract gene expression from compressed data
expression = t(h5read(destination_file, "data/expression", index=list(sample_locations, 1:length(genes))))
H5close()
rownames(expression) = genes
colnames(expression) = samples[sample_locations]

# Print file
write.table(expression, file=extracted_expression_file, sep="\t", quote=FALSE, col.names=NA)
print(paste0("Expression file was created at ", getwd(), "/", extracted_expression_file))

