# R script to download selected samples
# Copy code and run on a local machine to initiate download

library("rhdf5")    # can be installed using Bioconductor

destination_file = "human_matrix_v10.h5"
extracted_expression_file = "MDAMB468_expression_matrix.tsv"
url = "https://s3.amazonaws.com/mssm-seq-matrix/human_matrix_v10.h5"

# Check if gene expression file was already downloaded, if not in current directory download file form repository
if(!file.exists(destination_file)){
    print("Downloading compressed gene expression matrix.")
    download.file(url, destination_file, quiet = FALSE, mode = 'wb')
}

# Selected samples to be extracted
samp = c("GSM1848205","GSM1848207","GSM1848199","GSM1848206","GSM1848208","GSM1848202","GSM1848200","GSM1848201","GSM1848210","GSM1848203","GSM1848209","GSM1848204","GSM2278052","GSM2278053","GSM2278049","GSM2278051","GSM2278048","GSM2278050","GSM2509519","GSM2509525","GSM2509526","GSM2509523","GSM2509521","GSM2509522","GSM2509520","GSM2509524","GSM2226894","GSM2226895","GSM4188864","GSM4188865","GSM4188866",
"GSM4188867","GSM4114185","GSM4114186","GSM4114187","GSM4114188","GSM3930205","GSM3930206","GSM3930207","GSM3930208","GSM3930209","GSM3930210","GSM3930211","GSM3930212","GSM4013425","GSM4013426","GSM4013427","GSM4013428","GSM4013429","GSM4013430","GSM4013431","GSM4013432","GSM4013433","GSM4013434","GSM4013435","GSM4013436","GSM4013437","GSM4013438","GSM4013439","GSM4013440","GSM4013441",
"GSM4013442","GSM4013443","GSM4013444","GSM4013445","GSM4013446","GSM4013447","GSM4013448","GSM4013449","GSM4013450","GSM4013451","GSM4013452","GSM4013453","GSM4013454","GSM4013455","GSM4013456","GSM4612772","GSM4612773","GSM4612774","GSM4612775","GSM4612776","GSM4612777","GSM4612779","GSM4117335","GSM4117337","GSM4774659","GSM4774662","GSM4774663","GSM4774664","GSM4774665","GSM4774666",
"GSM5049717","GSM5049718","GSM5049719","GSM5049720","GSM5257959","GSM5386065","GSM5386066","GSM5386124","GSM5386125","GSM5386126","GSM5386127","GSM5386128","GSM5386129","GSM5386130","GSM5386131","GSM5386132","GSM5386133","GSM5386134","GSM5386135","GSM5386136","GSM5386137","GSM5386138","GSM5386139","GSM5386140","GSM5386141","GSM5386142","GSM5386143","GSM5386144","GSM5386145","GSM5386146",
"GSM5386147","GSM5386148","GSM5386149","GSM5386150","GSM5386151","GSM5386152","GSM5386153","GSM5386154","GSM5386155","GSM5386156","GSM5386157","GSM5386158","GSM5386159","GSM5386160","GSM5386161","GSM5386162","GSM5386163","GSM5386164","GSM5386165","GSM5386166","GSM5386167","GSM5386168","GSM5386169","GSM5386170","GSM5386171","GSM5386172","GSM5386173","GSM5386174","GSM5386175","GSM5386176",
"GSM5386177","GSM5386178","GSM5386179","GSM5386180","GSM5386181","GSM5386182","GSM5386183","GSM5386184","GSM5386185","GSM5386186","GSM5386187","GSM5386188","GSM5386189","GSM5386190","GSM5386191","GSM5386192","GSM5386193","GSM5386194","GSM5386195","GSM5386196","GSM5386197","GSM5386198","GSM5386199","GSM5386200","GSM5386201","GSM5386202","GSM5386203","GSM5386204","GSM5386205","GSM5386206",
"GSM5386207","GSM5386208","GSM5386209","GSM5386210","GSM5386211","GSM5386212","GSM5386213","GSM5386214","GSM5386215","GSM5386216","GSM5386217","GSM5386218","GSM5386219","GSM5386220","GSM5386221","GSM5386222","GSM5386223","GSM5386224","GSM5386225","GSM5386226","GSM5386227","GSM5386228","GSM5386229","GSM5386230","GSM5386231","GSM5386232","GSM5386233","GSM5386234","GSM5386235","GSM5386236",
"GSM5386237","GSM5386238","GSM5386239","GSM5386240","GSM5386241","GSM5386242","GSM5386243","GSM5386244","GSM5386245","GSM5386246","GSM5386247","GSM5386248","GSM5386249","GSM5386250","GSM5386251","GSM5386252","GSM5386253","GSM5386254","GSM5386255","GSM5386256","GSM5386257","GSM5386258","GSM5386259","GSM5386260","GSM5386261","GSM5386262","GSM5386263","GSM5386264","GSM5386265","GSM5386266",
"GSM5386267","GSM5386268","GSM5386269","GSM5386270","GSM5386271","GSM5386272","GSM5386273","GSM5386274","GSM5386275","GSM5386276","GSM5386277","GSM5386278","GSM5386279","GSM5386280","GSM5386281","GSM5386282","GSM5386283","GSM5386284","GSM5386285","GSM5386286","GSM5386287","GSM5386288","")

# Retrieve information from compressed data
samples = h5read(destination_file, "meta/samples/geo_accession")
genes = h5read(destination_file, "meta/genes/genes")

# Identify columns to be extracted
sample_locations = which(samples %in% samp)

# extract gene expression from compressed data
expression = t(h5read(destination_file, "data/expression", index=list(sample_locations, 1:length(genes))))
H5close()
rownames(expression) = genes
colnames(expression) = samples[sample_locations]

# Print file
write.table(expression, file=extracted_expression_file, sep="\t", quote=FALSE, col.names=NA)
print(paste0("Expression file was created at ", getwd(), "/", extracted_expression_file))

