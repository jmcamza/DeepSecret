# R script to download selected samples
# Copy code and run on a local machine to initiate download

library("rhdf5")    # can be installed using Bioconductor

destination_file = "human_matrix_v10.h5"
extracted_expression_file = "IMR32_expression_matrix.tsv"
url = "https://s3.amazonaws.com/mssm-seq-matrix/human_matrix_v10.h5"

# Check if gene expression file was already downloaded, if not in current directory download file form repository
if(!file.exists(destination_file)){
    print("Downloading compressed gene expression matrix.")
    download.file(url, destination_file, quiet = FALSE, mode = 'wb')
}

# Selected samples to be extracted
samp = c("GSM2027301","GSM2027306","GSM2027305","GSM2027304","GSM1885103","GSM1885107","GSM1885101","GSM2027302","GSM2027307","GSM1885104","GSM2027308","GSM2027309","GSM1885108","GSM1885106","GSM1885097","GSM1885099","GSM1885100","GSM2027303","GSM1885102","GSM1885105","GSM1885098","GSM2664384","GSM2405995","GSM2405996","GSM3244667","GSM3244668","GSM3244669","GSM3244670","GSM3244671","GSM3244672","GSM3607850",
"GSM3607851","GSM3607852","GSM3607853","GSM3607854","GSM3607855","GSM3607856","GSM3607857","GSM3607858","GSM3607859","GSM3607860","GSM3607861","GSM3607862","GSM3607863","GSM3607864","GSM3607865","GSM3607866","GSM3607867","GSM3607868","GSM3607869","GSM3607870","GSM3607871","GSM3607872","GSM3607873","GSM3607874","GSM3607875","GSM3607876","GSM3607877","GSM3607878","GSM3607879","GSM3607880",
"GSM3607881","GSM3607882","GSM3607883","GSM3607884","GSM3607885","GSM3607886","GSM3607887","GSM3607888","GSM3607889","GSM3607890","GSM3607891","GSM3607892","GSM3607893","GSM3607894","GSM3607895","GSM3607896","GSM3607897","GSM3607898","GSM3607899","GSM3607900","GSM3607901","GSM3607902","GSM3607903","GSM3607904","GSM3607905","GSM3607906","GSM3607907","GSM3607908","GSM3607909","GSM3607910",
"GSM3607911","GSM3607912","GSM3607913","GSM3607914","GSM3607915","GSM3607916","GSM3607917","GSM3607918","GSM3607919","GSM3607920","GSM3607921","GSM3607922","GSM3607923","GSM3607924","GSM3607925","GSM3607926","GSM3607927","GSM3607928","GSM3607929","GSM3607930","GSM3607931","GSM3607932","GSM3607933","GSM3607934","GSM3607935","GSM3607936","GSM3607937","GSM3607938","GSM3607939","GSM3607940",
"GSM3607941","GSM3607942","GSM3607943","GSM3607944","GSM3607945","GSM3607946","GSM3607947","GSM3607948","GSM3607949","GSM3607950","GSM3607951","GSM3607952","GSM3607953","GSM3607954","GSM3607955","GSM3607956","GSM3607957","GSM3607958","GSM3607959","GSM3607960","GSM3607961","GSM3607962","GSM3607963","GSM3607964","GSM3607965","GSM3607966","GSM3607967","GSM3607968","GSM3607969","GSM3607970",
"GSM3607971","GSM3607972","GSM3607973","GSM3607974","GSM3607975","GSM3607976","GSM3607977","GSM3607978","GSM3607979","GSM3607981","GSM3607982","GSM3607983","GSM3607984","GSM3607985","GSM3607986","GSM3607988","GSM3607989","GSM3607990","GSM3607991","GSM3607992","GSM3607993","GSM3607994","GSM3607995","GSM3607996","GSM3607997","GSM3607998","GSM3607999","GSM3608000","GSM3608001","GSM3608002",
"GSM3608003","GSM3608004","GSM3608005","GSM3608006","GSM3608007","GSM3608008","GSM3608009","GSM3608010","GSM3608011","GSM3608013","GSM3608014","GSM3608015","GSM3608016","GSM3608017","GSM3608018","GSM3608019","GSM3608020","GSM3608021","GSM3608022","GSM3608023","GSM3608024","GSM3608025","GSM3608026","GSM3608027","GSM3608029","GSM3608030","GSM3608031","GSM3608032","GSM3608033","GSM3608034",
"GSM3608035","GSM3608036","GSM3608037","GSM3608038","GSM3608039","GSM3608040","GSM3608041","GSM3103137","GSM3103138","GSM3103139","GSM3103140","GSM3103141","GSM3103142","GSM3103144","GSM3103147","GSM3103148","GSM3103149","GSM3103151","GSM4879944","GSM4879945","GSM4879946","GSM4879947","GSM4879948","GSM4879949","GSM4879950","GSM4879951","GSM4914106","GSM4914107","GSM4914108","GSM4914109",
"GSM4914110","GSM4914111","GSM4117240","GSM4117241","GSM4117242","GSM4661322","GSM4661323","GSM4661324","GSM4661325","GSM4661326","GSM4661327","")

# Retrieve information from compressed data
samples = h5read(destination_file, "meta/samples/geo_accession")
genes = h5read(destination_file, "meta/genes/genes")

# Identify columns to be extracted
sample_locations = which(samples %in% samp)

# extract gene expression from compressed data
expression = t(h5read(destination_file, "data/expression", index=list(sample_locations, 1:length(genes))))
H5close()
rownames(expression) = genes
colnames(expression) = samples[sample_locations]

# Print file
write.table(expression, file=extracted_expression_file, sep="\t", quote=FALSE, col.names=NA)
print(paste0("Expression file was created at ", getwd(), "/", extracted_expression_file))

