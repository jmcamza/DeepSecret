# R script to download selected samples
# Copy code and run on a local machine to initiate download

library("rhdf5")    # can be installed using Bioconductor

destination_file = "human_matrix_v10.h5"
extracted_expression_file = "PANC1_expression_matrix.tsv"
url = "https://s3.amazonaws.com/mssm-seq-matrix/human_matrix_v10.h5"

# Check if gene expression file was already downloaded, if not in current directory download file form repository
if(!file.exists(destination_file)){
    print("Downloading compressed gene expression matrix.")
    download.file(url, destination_file, quiet = FALSE, mode = 'wb')
}

# Selected samples to be extracted
samp = c("GSM1556985","GSM1556983","GSM1950233","GSM1950239","GSM1556986","GSM2086985","GSM1950231","GSM1556987","GSM1556982","GSM2086986","GSM1950237","GSM1950235","GSM1950230","GSM2086984","GSM1556984","GSM2086987","GSM1574308","GSM1574307","GSM2398415","GSM2398409","GSM2398408","GSM2398419","GSM2398414","GSM2398413","GSM2398416","GSM2398412","GSM2398410","GSM2398417","GSM2398418","GSM2398411","GSM2406935",
"GSM2406933","GSM2406926","GSM2406927","GSM2406932","GSM2406930","GSM2406929","GSM2406925","GSM2406924","GSM2406931","GSM2406928","GSM2406934","GSM2466354","GSM2466353","GSM2466352","GSM2466355","GSM1819853","GSM1819854","GSM1819855","GSM1819856","GSM2559756","GSM2559757","GSM2559758","GSM2559759","GSM2559760","GSM2559761","GSM2559762","GSM2559763","GSM2559764","GSM2559765","GSM2559766",
"GSM2559767","GSM2803033","GSM2803034","GSM2803035","GSM2803036","GSM2803037","GSM2803038","GSM2183482","GSM2183483","GSM2183484","GSM2183485","GSM2183486","GSM2183487","GSM2183488","GSM2183489","GSM2183490","GSM2345118","GSM2345119","GSM2345120","GSM2345121","GSM2345122","GSM2345123","GSM2345124","GSM2345125","GSM2345126","GSM2345127","GSM2345128","GSM2345129","GSM2546220","GSM2546221",
"GSM2546222","GSM2546223","GSM2546224","GSM2546225","GSM2546226","GSM2546228","GSM2835220","GSM2835221","GSM2835222","GSM2835223","GSM2835224","GSM2835225","GSM2835226","GSM2835227","GSM2835228","GSM2835229","GSM2835230","GSM2835231","GSM2835232","GSM2835233","GSM2835234","GSM2835235","GSM2835236","GSM2835237","GSM2835238","GSM2835239","GSM2835240","GSM2835241","GSM2835242","GSM2835243",
"GSM3430674","GSM3430675","GSM3430676","GSM3430683","GSM3430684","GSM3430685","GSM2279678","GSM2279679","GSM2279680","GSM2279681","GSM2279682","GSM2279683","GSM2279684","GSM2279685","GSM2279686","GSM2279687","GSM2279688","GSM2279689","GSM2279690","GSM2279691","GSM2747671","GSM2747672","GSM2747673","GSM2747674","GSM2747675","GSM2747676","GSM2747677","GSM2747678","GSM3178699","GSM3486131",
"GSM3003520","GSM3003521","GSM3003522","GSM3003523","GSM3003524","GSM3003525","GSM3387462","GSM3387463","GSM3387464","GSM3387465","GSM3387466","GSM3387467","GSM4222745","GSM4222746","GSM4222747","GSM4222748","GSM4222749","GSM4222750","GSM4222751","GSM4222752","GSM4222753","GSM4222754","GSM4222755","GSM4222756","GSM4222769","GSM4222770","GSM4222771","GSM4222772","GSM4222773","GSM4222774",
"GSM4222775","GSM4222776","GSM4222777","GSM4222778","GSM4222779","GSM4222780","GSM4043831","GSM4043832","GSM4043833","GSM4043834","GSM4043835","GSM4043836","GSM4162795","GSM4209435","GSM4209436","GSM2790124","GSM2790125","GSM2790126","GSM2790127","GSM2790128","GSM2790129","GSM2790130","GSM2790131","GSM2790132","GSM2790133","GSM2790134","GSM2790135","GSM3764520","GSM3764521","GSM3764522",
"GSM3764523","GSM3764524","GSM3764525","GSM3790555","GSM3790556","GSM3790557","GSM3790558","GSM3395010","GSM3395012","GSM3395014","GSM4404688","GSM4458590","GSM4458591","GSM4458592","GSM4458593","GSM4458596","GSM4458597","GSM4458598","GSM4458599","GSM4752902","GSM4752903","GSM4752904","GSM4752907","GSM4752908","GSM4752909","GSM4752910","GSM5111130","GSM5111132","GSM5330680","")

# Retrieve information from compressed data
samples = h5read(destination_file, "meta/samples/geo_accession")
genes = h5read(destination_file, "meta/genes/genes")

# Identify columns to be extracted
sample_locations = which(samples %in% samp)

# extract gene expression from compressed data
expression = t(h5read(destination_file, "data/expression", index=list(sample_locations, 1:length(genes))))
H5close()
rownames(expression) = genes
colnames(expression) = samples[sample_locations]

# Print file
write.table(expression, file=extracted_expression_file, sep="\t", quote=FALSE, col.names=NA)
print(paste0("Expression file was created at ", getwd(), "/", extracted_expression_file))

