# R script to download selected samples
# Copy code and run on a local machine to initiate download

library("rhdf5")    # can be installed using Bioconductor

destination_file = "human_matrix_v10.h5"
extracted_expression_file = "THP1_expression_matrix.tsv"
url = "https://s3.amazonaws.com/mssm-seq-matrix/human_matrix_v10.h5"

# Check if gene expression file was already downloaded, if not in current directory download file form repository
if(!file.exists(destination_file)){
    print("Downloading compressed gene expression matrix.")
    download.file(url, destination_file, quiet = FALSE, mode = 'wb')
}

# Selected samples to be extracted
samp = c("GSM927668","GSM1906585","GSM1520904","GSM1873008","GSM1520905","GSM1873014","GSM1872992","GSM1873003","GSM1873012","GSM1873000","GSM1873010","GSM1873004","GSM1906588","GSM1872993","GSM1906590","GSM1906587","GSM1873013","GSM1873007","GSM1872998","GSM1872999","GSM1873005","GSM1873006","GSM1873016","GSM1872997","GSM1873002","GSM1872996","GSM1906589","GSM1520906","GSM1873017","GSM1906586","GSM1872995",
"GSM1520903","GSM1872994","GSM1873001","GSM1873009","GSM1873015","GSM2282050","GSM2282049","GSM2282043","GSM2282044","GSM1873011","GSM1843218","GSM2108051","GSM2108050","GSM2599710","GSM2599709","GSM2599707","GSM2599708","GSM2327721","GSM2327722","GSM2051116","GSM2051117","GSM2051118","GSM2051119","GSM2051120","GSM2051121","GSM2051122","GSM2051123","GSM2051124","GSM2051125","GSM2051126",
"GSM2051127","GSM2051128","GSM2051129","GSM2051130","GSM2051131","GSM2464317","GSM2464318","GSM2535330","GSM2535331","GSM2535332","GSM2535333","GSM2535334","GSM2535335","GSM2779058","GSM2779059","GSM2779060","GSM2779061","GSM2636354","GSM2636355","GSM2636356","GSM2636357","GSM2636358","GSM2636359","GSM2636360","GSM2636361","GSM2636362","GSM2636363","GSM2636364","GSM2636365","GSM3161742",
"GSM3161743","GSM3161744","GSM3161745","GSM3161746","GSM3161747","GSM2704187","GSM2704188","GSM2704189","GSM2704190","GSM2704191","GSM2704192","GSM3272728","GSM3272729","GSM3272730","GSM3111897","GSM3111898","GSM3112119","GSM3112120","GSM3112121","GSM3112122","GSM3112123","GSM3112124","GSM3112125","GSM3112126","GSM3112127","GSM3112128","GSM2046117","GSM2046118","GSM2046119","GSM2046120",
"GSM3405963","GSM3405964","GSM2865802","GSM2865803","GSM2865804","GSM3145093","GSM3145094","GSM3145095","GSM3145096","GSM3145097","GSM2825147","GSM2825148","GSM2825149","GSM2825150","GSM2825151","GSM2825152","GSM2825153","GSM2825154","GSM2825155","GSM2825156","GSM2910935","GSM2910936","GSM2910937","GSM2910938","GSM2910939","GSM2910941","GSM2910942","GSM3271331","GSM3271332","GSM3271333",
"GSM3271334","GSM3271336","GSM3271337","GSM3271338","GSM3271339","GSM3271340","GSM3271341","GSM3271342","GSM3204337","GSM3204338","GSM3563683","GSM3563684","GSM3563685","GSM3563686","GSM3563687","GSM3563688","GSM3563689","GSM3563690","GSM3563691","GSM3563692","GSM3563693","GSM3563694","GSM3563695","GSM3563696","GSM3563697","GSM3563698","GSM3193298","GSM3193299","GSM3193300","GSM3193301",
"GSM3193302","GSM3193303","GSM3193304","GSM3193305","GSM3193306","GSM3193307","GSM3193308","GSM3193309","GSM3193310","GSM3193311","GSM3193312","GSM3193313","GSM3193314","GSM3193315","GSM3681466","GSM3681467","GSM3681468","GSM3665044","GSM3665045","GSM3665046","GSM3665047","GSM3665048","GSM3665049","GSM3665050","GSM3665051","GSM3665052","GSM3665053","GSM3665054","GSM3665055","GSM3689288",
"GSM3689289","GSM3689290","GSM3689291","GSM3729250","GSM3729251","GSM3729252","GSM3729253","GSM3729254","GSM3729255","GSM3729256","GSM3729257","GSM3729258","GSM3729259","GSM3729260","GSM3729261","GSM3729262","GSM3729263","GSM3729264","GSM3758290","GSM3758291","GSM3758292","GSM3758293","GSM3758294","GSM3758295","GSM3946277","GSM3946278","GSM3946279","GSM3946280","GSM3946281","GSM3946282",
"GSM3946283","GSM3946284","GSM3946285","GSM3946286","GSM3946287","GSM3946288","GSM3946289","GSM3946290","GSM3946291","GSM3946292","GSM3946293","GSM3946294","GSM3946295","GSM3946296","GSM3946297","GSM3946298","GSM3946299","GSM3946300","GSM3946301","GSM3946302","GSM3946303","GSM3946304","GSM3946305","GSM3946306","GSM3946307","GSM3946308","GSM3946309","GSM3946310","GSM3946311","GSM3946312",
"GSM3946313","GSM3946314","GSM3946315","GSM3946316","GSM3946317","GSM3946318","GSM3946319","GSM3946320","GSM3946321","GSM3972316","GSM3972317","GSM3972318","GSM3972319","GSM3972320","GSM3972321","GSM3972322","GSM3972323","GSM3972324","GSM3972325","GSM3972326","GSM3972327","GSM3972328","GSM3972329","GSM3972330","GSM3972331","GSM3972332","GSM3972333","GSM3972334","GSM3972335","GSM3972336",
"GSM3972337","GSM3972338","GSM3972339","GSM3972340","GSM3972341","GSM3972342","GSM3972343","GSM3972344","GSM3972345","GSM3972346","GSM3972347","GSM3972348","GSM3972349","GSM3972350","GSM3972351","GSM3972352","GSM3972353","GSM3972354","GSM3972355","GSM3972356","GSM3972357","GSM3972358","GSM3972359","GSM3972360","GSM3972361","GSM3972362","GSM3972363","GSM3972364","GSM3972365","GSM3972366",
"GSM3972367","GSM3972368","GSM3972369","GSM3972370","GSM3972371","GSM3972372","GSM3972373","GSM3972374","GSM3972375","GSM3972376","GSM3972377","GSM3972378","GSM3972379","GSM3972380","GSM3972381","GSM3972382","GSM3972383","GSM3602428","GSM3602429","GSM3602430","GSM3602431","GSM3602432","GSM3602433","GSM3602434","GSM3602435","GSM3602436","GSM3602437","GSM3602438","GSM3602439","GSM2837071",
"GSM2837072","GSM2837073","GSM2837074","GSM2837075","GSM2837076","GSM3396059","GSM3396060","GSM3396061","GSM3396062","GSM3396063","GSM3396064","GSM3396065","GSM3396066","GSM3396067","GSM3396068","GSM3396069","GSM3396070","GSM3580916","GSM3580917","GSM3580918","GSM3580919","GSM3587609","GSM3587610","GSM3587611","GSM3587612","GSM3587613","GSM3587614","GSM3587615","GSM3587616","GSM3587617",
"GSM3587618","GSM3587619","GSM3587620","GSM3587621","GSM3587622","GSM3587623","GSM3587624","GSM3746500","GSM3746501","GSM3746502","GSM3746503","GSM3746504","GSM3746505","GSM3905630","GSM3905631","GSM3905632","GSM3905633","GSM3905634","GSM3905635","GSM3905636","GSM3905637","GSM3905638","GSM3905639","GSM3905640","GSM3905641","GSM3905642","GSM3905643","GSM3905644","GSM3905645","GSM3905646",
"GSM3905647","GSM3905648","GSM3905649","GSM3905650","GSM3905651","GSM3905652","GSM3905653","GSM3905654","GSM3905655","GSM3905656","GSM3905657","GSM3905658","GSM3905659","GSM4199151","GSM4199152","GSM4199153","GSM4199154","GSM4199155","GSM4199156","GSM4199157","GSM4199158","GSM4199159","GSM4199160","GSM4199161","GSM4199162","GSM4202050","GSM4202051","GSM4202052","GSM4202053","GSM4275311",
"GSM4275312","GSM4275313","GSM4275314","GSM4276784","GSM4276785","GSM4276786","GSM4276787","GSM4276788","GSM4306630","GSM4306631","GSM4306632","GSM4306633","GSM4306634","GSM4306635","GSM4306636","GSM4306637","GSM4476247","GSM4476248","GSM4476249","GSM4476250","GSM4476251","GSM4476252","GSM4476253","GSM4476254","GSM4476255","GSM4476256","GSM4476257","GSM4476258","GSM4476259","GSM4476260",
"GSM4476261","GSM4476262","GSM4476263","GSM4476264","GSM4476265","GSM4476266","GSM4476267","GSM4476268","GSM4476269","GSM4476270","GSM4476271","GSM4476272","GSM4476273","GSM4476274","GSM4476275","GSM4476276","GSM4476277","GSM4476278","GSM4476279","GSM4476280","GSM4476281","GSM4476282","GSM4476283","GSM4476284","GSM4476285","GSM4476286","GSM4476287","GSM4476288","GSM4476289","GSM4476290",
"GSM4476291","GSM4476292","GSM4476293","GSM4476294","GSM4476295","GSM4476296","GSM4476297","GSM4476298","GSM4476299","GSM4476300","GSM4476301","GSM4476302","GSM4476303","GSM4476304","GSM4476305","GSM4476306","GSM4476307","GSM4476308","GSM4476309","GSM4476310","GSM4476311","GSM4476312","GSM4194790","GSM4194791","GSM4194792","GSM4194793","GSM4194794","GSM4194795","GSM4194796","GSM4194797",
"GSM4194798","GSM4419211","GSM4419212","GSM4419213","GSM4419214","GSM4676404","GSM4676405","GSM4676406","GSM4676407","GSM4679548","GSM4679549","GSM4679550","GSM4679551","GSM4679552","GSM4679553","GSM4779266","GSM4779267","GSM4779268","GSM4779269","GSM4828775","GSM4828776","GSM4828777","GSM4828778","GSM2897329","GSM2897330","GSM2897331","GSM2897332","GSM2912650","GSM2912651","GSM2912652",
"GSM2912653","GSM2912654","GSM2912655","GSM2912657","GSM2912658","GSM2912660","GSM2912661","GSM2912662","GSM3572782","GSM3572783","GSM3572784","GSM3572785","GSM3572787","GSM3572788","GSM3572789","GSM3572790","GSM3680381","GSM3680382","GSM3680383","GSM3680384","GSM3680385","GSM3680386","GSM3680387","GSM3680388","GSM3680389","GSM3731849","GSM3731850","GSM3731851","GSM3731852","GSM3731853",
"GSM3731854","GSM3731855","GSM3731856","GSM3731857","GSM3731858","GSM4007077","GSM4007078","GSM4007079","GSM4007080","GSM4007081","GSM4007082","GSM4007083","GSM4007084","GSM4007085","GSM4007086","GSM4007087","GSM4007088","GSM4007089","GSM4007090","GSM4007091","GSM4007092","GSM4007093","GSM4007094","GSM4007095","GSM4007096","GSM4007097","GSM4007098","GSM4007099","GSM4007100","GSM4007101",
"GSM4007102","GSM4007155","GSM4007156","GSM4007157","GSM4007158","GSM4007159","GSM4007160","GSM4007161","GSM4007162","GSM4007163","GSM4007164","GSM4007165","GSM4007166","GSM4007167","GSM4007168","GSM4007169","GSM4007170","GSM4007171","GSM4007172","GSM4007173","GSM4007174","GSM4007175","GSM4007176","GSM4007177","GSM4007178","GSM4007179","GSM4007180","GSM4321733","GSM4321734","GSM4321736",
"GSM4376662","GSM4376663","GSM4376664","GSM4376665","GSM4376666","GSM4376667","GSM4376668","GSM4376669","GSM4376670","GSM4376671","GSM4376672","GSM4376673","GSM4376674","GSM4376675","GSM4376676","GSM4376677","GSM4376678","GSM4376679","GSM4425674","GSM4425675","GSM4425676","GSM4425677","GSM4425678","GSM4425679","GSM4425680","GSM4425681","GSM4425682","GSM4425683","GSM4425684","GSM4425685",
"GSM4425686","GSM4425687","GSM4425688","GSM4552490","GSM4552491","GSM4706286","GSM4706287","GSM4706288","GSM4706289","GSM4706290","GSM4706291","GSM4706292","GSM4706293","GSM4706294","GSM4706295","GSM4706296","GSM4706297","GSM4706298","GSM4706299","GSM4706300","GSM4706301","GSM4706302","GSM4706303","GSM4706304","GSM4706306","GSM4706307","GSM4706308","GSM4706309","GSM4769124","GSM4769125",
"GSM4769126","GSM4769127","GSM4769128","GSM4769129","GSM4769130","GSM4769131","GSM4769132","GSM4769133","GSM4769134","GSM4769135","GSM4769136","GSM4769137","GSM4769138","GSM4769139","GSM4769140","GSM4769141","GSM4769142","GSM4769143","GSM4769144","GSM4769145","GSM4769147","GSM4769148","GSM4769150","GSM4769151","GSM4769152","GSM4769153","GSM4769154","GSM4769155","GSM4771868","GSM4771869",
"GSM4771870","GSM4771871","GSM4824687","GSM4824688","GSM4824691","GSM4824692","GSM4824694","GSM4824695","GSM4824696","GSM4824697","GSM4890857","GSM4890858","GSM4890859","GSM4890860","GSM4890861","GSM4890862","GSM4890863","GSM4890864","GSM4890866","GSM4890867","GSM4890868","GSM4927884","GSM4927885","GSM4927886","GSM4927890","GSM4927898","GSM4927901","GSM4927902","GSM4927903","GSM4927906",
"GSM4927910","GSM4927911","GSM4927916","GSM4927917","GSM4927919","GSM4927924","GSM4927925","GSM4927926","GSM4927927","GSM5068276","GSM5068277","GSM5068278","GSM5068279","GSM5068280","GSM5068281","GSM5092491","GSM5092492","GSM5092493","GSM5092495","GSM5092496","GSM5105945","GSM5105947","GSM5105948","GSM5105950","GSM5172392","GSM5172393","GSM5264994","GSM5352712","GSM5352751","GSM5352753",
"GSM5352754","GSM5362313","GSM5362314","GSM5362315","GSM5362316","GSM5362317","GSM5362318","GSM5362319","GSM5362320","GSM5362321","GSM5362322","GSM5362323","GSM5362324","GSM5362325","GSM5362327","GSM5362328","GSM5379642","GSM5379643","GSM5379644","GSM5379645","GSM5379646","GSM5379647","GSM5379648","GSM5379649","GSM5379650","GSM5379651","GSM5379652","GSM5379653","GSM5379702","GSM5379703",
"GSM5379704","GSM5379705","GSM5379706","GSM5379707","GSM5389614","GSM5389615","GSM5389617","GSM5389618","GSM5389620","GSM5389621","GSM5389622","GSM5389623","GSM5389625","GSM5389626","GSM5389629","GSM5410589","GSM5410590","GSM5410591","GSM5410593","GSM5410594","GSM5468561","GSM5468562","GSM5468563","GSM5468564","GSM5468565","GSM5468566","GSM5468567","GSM5468568","GSM5468569","GSM5468570",
"GSM5468571","GSM5468572","GSM5468573","GSM5468574","GSM5468575","GSM5468576","GSM5468577","GSM5468578","GSM5468579","GSM5468580","GSM5468581","GSM5468582","GSM5468583","GSM5468584","GSM5468585","GSM5468586","GSM5468587","GSM5468588","GSM5468589","GSM5468590","GSM5468591","GSM5468592","GSM5468593","GSM5468594","GSM5468595","GSM5468596","GSM5468599","GSM5468601","GSM5468602","GSM5468603",
"GSM5468604","GSM5468605","GSM5468606","GSM5468607","GSM5468608","GSM5468609","GSM5468610","GSM5468611","GSM5468612","GSM5468613","GSM5468614","GSM5468615","GSM5468616","GSM5468617","GSM5468618","GSM5468619","GSM5468620","GSM5468621","GSM5468622","GSM5468623","GSM5468624","GSM5468625","GSM5468626","GSM5468627","GSM5468629","GSM5468630","GSM5468631","GSM5468632","GSM5468633","GSM5468634",
"GSM5468635","GSM5468636","GSM5468637","GSM5468638","GSM5468639","GSM5468641","GSM5468642","GSM5468643","GSM5468644","GSM5468645","GSM5468646","GSM5468647","GSM5468648","GSM5468649","GSM5468650","GSM5468651","GSM5468652","GSM5468653","GSM5468654","GSM5468655","GSM5468657","GSM5468658","GSM5468659","GSM5468660","GSM5491650","GSM5491651","GSM5491652","GSM5491657","GSM5491659","GSM5491660",
"GSM5491663","GSM5491671","GSM5491674","GSM5491675","GSM5491689","GSM5491690","GSM5491691","GSM5491692","")

# Retrieve information from compressed data
samples = h5read(destination_file, "meta/samples/geo_accession")
genes = h5read(destination_file, "meta/genes/genes")

# Identify columns to be extracted
sample_locations = which(samples %in% samp)

# extract gene expression from compressed data
expression = t(h5read(destination_file, "data/expression", index=list(sample_locations, 1:length(genes))))
H5close()
rownames(expression) = genes
colnames(expression) = samples[sample_locations]

# Print file
write.table(expression, file=extracted_expression_file, sep="\t", quote=FALSE, col.names=NA)
print(paste0("Expression file was created at ", getwd(), "/", extracted_expression_file))

