# R script to download selected samples
# Copy code and run on a local machine to initiate download

library("rhdf5")    # can be installed using Bioconductor

destination_file = "human_matrix_v10.h5"
extracted_expression_file = "Neutrophil_expression_matrix.tsv"
url = "https://s3.amazonaws.com/mssm-seq-matrix/human_matrix_v10.h5"

# Check if gene expression file was already downloaded, if not in current directory download file form repository
if(!file.exists(destination_file)){
    print("Downloading compressed gene expression matrix.")
    download.file(url, destination_file, quiet = FALSE, mode = 'wb')
}

# Selected samples to be extracted
samp = c("GSM996198","GSM996200","GSM996201","GSM996197","GSM996199","GSM996202","GSM1438894","GSM1716668","GSM1438896","GSM1716669","GSM1576432","GSM1576404","GSM1716674","GSM1716673","GSM1438895","GSM1576405","GSM1576403","GSM1716666","GSM1716664","GSM1716670","GSM1576434","GSM1576406","GSM1716672","GSM1576431","GSM1576433","GSM1716671","GSM1716667","GSM1438897","GSM1716663","GSM1633868","GSM1633866",
"GSM1633867","GSM1716665","GSM2730425","GSM2730426","GSM2730427","GSM2730428","GSM2730429","GSM2730430","GSM2730431","GSM2730432","GSM2730433","GSM2730434","GSM2730435","GSM2730436","GSM2730437","GSM2730438","GSM2730439","GSM2730440","GSM2730441","GSM2730442","GSM2839721","GSM2839722","GSM2839723","GSM2839724","GSM2839725","GSM2839726","GSM2839727","GSM2839728","GSM2839729","GSM2839730",
"GSM2839731","GSM2839732","GSM2839733","GSM2839734","GSM2839735","GSM2839736","GSM2839737","GSM2839738","GSM2839739","GSM2839740","GSM2839741","GSM2839742","GSM2839743","GSM2839744","GSM2839745","GSM2839746","GSM2839747","GSM2839748","GSM2839749","GSM2839750","GSM2839751","GSM2839752","GSM2084401","GSM2084402","GSM2084403","GSM2084404","GSM2084405","GSM2084406","GSM2084407","GSM2084408",
"GSM2084409","GSM2084410","GSM2084411","GSM2084412","GSM2084413","GSM2084414","GSM2084415","GSM2084416","GSM2084417","GSM2084418","GSM2084419","GSM2084420","GSM2084421","GSM2084422","GSM2084423","GSM2084424","GSM2320012","GSM2320013","GSM2320014","GSM2320015","GSM2756550","GSM2756551","GSM2756552","GSM2756553","GSM2756554","GSM2756555","GSM3272795","GSM3272796","GSM3416566","GSM3416567",
"GSM3416568","GSM3416569","GSM3416570","GSM3416571","GSM3416572","GSM3416573","GSM3416574","GSM3416575","GSM3416576","GSM3416577","GSM3612259","GSM3612260","GSM3612261","GSM3612262","GSM3612263","GSM3612264","GSM3335818","GSM3335819","GSM3335820","GSM3335821","GSM3335822","GSM3335823","GSM3335824","GSM3335825","GSM3335826","GSM3335827","GSM3335828","GSM3335829","GSM3335830","GSM3335831",
"GSM3335832","GSM3335833","GSM3335834","GSM3335835","GSM3335836","GSM3335837","GSM3335838","GSM3335839","GSM3511360","GSM3511361","GSM3511362","GSM3511363","GSM3511364","GSM3511365","GSM3511366","GSM3511367","GSM3511368","GSM3511369","GSM3511370","GSM3511371","GSM3511372","GSM3511373","GSM3511374","GSM3511375","GSM3511376","GSM3511377","GSM3511378","GSM3018807","GSM3018808","GSM3018809",
"GSM3018810","GSM3018811","GSM3018812","GSM3018813","GSM3018814","GSM3018815","GSM3018816","GSM3018817","GSM3018818","GSM3018819","GSM3018820","GSM3018821","GSM3018822","GSM3018823","GSM3018824","GSM3018825","GSM3018826","GSM3018827","GSM3018828","GSM3018829","GSM3018830","GSM3018831","GSM3018832","GSM3018833","GSM3018834","GSM3018835","GSM3018836","GSM3018837","GSM3018838","GSM3018839",
"GSM3018840","GSM3018841","GSM3018842","GSM3018843","GSM3018844","GSM3018845","GSM3018846","GSM3018847","GSM3018848","GSM3188503","GSM3188522","GSM3188532","GSM2859437","GSM2859466","GSM2859495","GSM2859529","GSM3057645","GSM3057648","GSM3057650","GSM3057654","GSM2228263","GSM2228264","GSM2228265","GSM2228266","GSM2228267","GSM2228268","GSM2228269","GSM2228270","GSM2228271","GSM2228272",
"GSM2228273","GSM2228274","GSM2228275","GSM2228276","GSM2228277","GSM2228278","GSM2228279","GSM2228280","GSM2228281","GSM2228282","GSM4053588","GSM4053589","GSM4053590","GSM4053591","GSM4053592","GSM4053593","GSM2913479","GSM2913480","GSM2913481","GSM2913482","GSM2913483","GSM2913484","GSM2913485","GSM2913486","GSM2913487","GSM2913488","GSM2913489","GSM2913490","GSM3591473","GSM3591474",
"GSM3591475","GSM3591476","GSM3591477","GSM3591478","GSM3591481","GSM3591482","GSM3591483","GSM3591484","GSM3591485","GSM3591487","GSM4066481","GSM4066482","GSM4066483","GSM4066484","GSM4066485","GSM4066486","GSM4066487","GSM4066488","GSM4066489","GSM4066490","GSM4066491","GSM4066492","GSM4066493","GSM4066494","GSM4155525","GSM4155526","GSM4155527","GSM4155528","GSM4155571","GSM4155572",
"GSM4155573","GSM4155614","GSM4155615","GSM4155616","GSM4225730","GSM4225731","GSM4225732","GSM4225733","GSM4225734","GSM4225735","GSM4225736","GSM4225737","GSM4225738","GSM4225739","GSM4225740","GSM4225741","GSM4225742","GSM4225743","GSM4225744","GSM4225745","GSM4225746","GSM4225747","GSM4225748","GSM4225749","GSM4225750","GSM4225751","GSM4225752","GSM4225753","GSM4225754","GSM4225755",
"GSM4225756","GSM4225757","GSM4225758","GSM4225759","GSM4225760","GSM4225761","GSM4225762","GSM4225763","GSM4225764","GSM4225765","GSM4225766","GSM4225767","GSM4225768","GSM4225769","GSM4225770","GSM4225771","GSM4225772","GSM4225773","GSM4225774","GSM4225775","GSM4225778","GSM4225779","GSM4225780","GSM4225781","GSM4225782","GSM4225783","GSM4225784","GSM4225785","GSM4225786","GSM4225787",
"GSM4225788","GSM4225789","GSM4225790","GSM4225791","GSM4225792","GSM4225793","GSM4225794","GSM4225795","GSM4225796","GSM4225797","GSM4225798","GSM4225799","GSM4225800","GSM4225801","GSM4225802","GSM4225803","GSM4225804","GSM4225805","GSM4225806","GSM4225807","GSM4225808","GSM4225809","GSM4225810","GSM4225811","GSM4225812","GSM4225813","GSM4225814","GSM4225815","GSM4225816","GSM4225817",
"GSM4225818","GSM4225819","GSM4225820","GSM4225821","GSM4225822","GSM4225823","GSM4225824","GSM4225825","GSM4225826","GSM4225827","GSM4225828","GSM4225829","GSM4225830","GSM4225831","GSM4225832","GSM4225833","GSM4225834","GSM4225835","GSM4225836","GSM4225837","GSM4225838","GSM4225839","GSM4225840","GSM4225841","GSM4225842","GSM4225843","GSM4225844","GSM4225845","GSM4225846","GSM4225847",
"GSM4225848","GSM4225849","GSM4225850","GSM4225851","GSM4225852","GSM4225853","GSM4225854","GSM4225855","GSM4225856","GSM4225857","GSM4225858","GSM4225859","GSM4225860","GSM4225861","GSM4225862","GSM4225863","GSM4225864","GSM4225865","GSM4225866","GSM4225867","GSM4225868","GSM4225869","GSM4225870","GSM4225871","GSM4225872","GSM4225873","GSM4225874","GSM4225875","GSM4225876","GSM4225877",
"GSM4225878","GSM4225879","GSM4225880","GSM4225881","GSM4225882","GSM4225883","GSM4225884","GSM4225885","GSM4225886","GSM4225887","GSM4225888","GSM4225889","GSM4225890","GSM4225891","GSM4225892","GSM4225893","GSM4225894","GSM4225895","GSM4225896","GSM4225897","GSM4225898","GSM4225899","GSM4225900","GSM4225901","GSM4225902","GSM4225903","GSM4225904","GSM4225905","GSM4225906","GSM4225907",
"GSM4225908","GSM4225909","GSM4225910","GSM4225911","GSM4225912","GSM4225913","GSM4225914","GSM4225915","GSM4225916","GSM4225917","GSM4225918","GSM4225919","GSM4225920","GSM4225921","GSM4225922","GSM4225923","GSM4225924","GSM4225925","GSM4225926","GSM4225927","GSM4225928","GSM4225929","GSM4225930","GSM4225931","GSM4225932","GSM4225933","GSM4225934","GSM4225935","GSM4225936","GSM4225937",
"GSM4225938","GSM4225939","GSM4225940","GSM4225941","GSM4225942","GSM4225943","GSM4225944","GSM4225945","GSM4225946","GSM4225947","GSM4225948","GSM4225949","GSM4225950","GSM4225951","GSM4225952","GSM4225953","GSM4225954","GSM4225955","GSM4225956","GSM4225957","GSM4225958","GSM4225959","GSM4225960","GSM4225961","GSM4225962","GSM4225963","GSM4225964","GSM4225965","GSM4225966","GSM4225967",
"GSM4225968","GSM4225969","GSM4225970","GSM4225971","GSM4225972","GSM4225973","GSM4225974","GSM4225975","GSM4225976","GSM4225977","GSM4225978","GSM4225979","GSM4225980","GSM4225981","GSM4225982","GSM4225983","GSM4225984","GSM4225985","GSM4225986","GSM4225987","GSM4225988","GSM4225989","GSM4225990","GSM4225991","GSM4225992","GSM4225993","GSM4225994","GSM4225995","GSM4225996","GSM4225997",
"GSM4225998","GSM4225999","GSM4226000","GSM4226001","GSM4226002","GSM4226003","GSM4226004","GSM4226005","GSM4226006","GSM4226007","GSM4226008","GSM4226009","GSM4226010","GSM4226011","GSM4226012","GSM4226013","GSM4226014","GSM4226015","GSM4226016","GSM4226017","GSM4226018","GSM4226019","GSM4226020","GSM4226021","GSM4226022","GSM4226023","GSM4226024","GSM4226025","GSM4226026","GSM4226027",
"GSM4226028","GSM4226029","GSM4226030","GSM4226031","GSM4226032","GSM4226033","GSM4226034","GSM4226035","GSM4226036","GSM4226037","GSM4226039","GSM4226040","GSM4226041","GSM4226042","GSM4226043","GSM4226044","GSM4226045","GSM4226046","GSM4226047","GSM4226048","GSM4226049","GSM4226050","GSM4226051","GSM4226052","GSM4226053","GSM4226054","GSM4226055","GSM4226056","GSM4226057","GSM4226058",
"GSM4226059","GSM4226060","GSM4226061","GSM4226062","GSM4226063","GSM4226064","GSM4226065","GSM4226066","GSM4226067","GSM4226068","GSM4226069","GSM4226070","GSM4226071","GSM4226072","GSM4226073","GSM4226074","GSM4226075","GSM4226076","GSM4226077","GSM4226078","GSM4226079","GSM4226080","GSM4226081","GSM4226082","GSM4226083","GSM4226084","GSM4226085","GSM4226086","GSM4226087","GSM4226088",
"GSM4226089","GSM4226090","GSM4226091","GSM4226092","GSM4226093","GSM4226094","GSM4226095","GSM4226096","GSM4226097","GSM4226098","GSM4226099","GSM4226100","GSM4226102","GSM4226103","GSM4226104","GSM4226105","GSM4226106","GSM4226107","GSM4226108","GSM4226109","GSM4304663","GSM4304664","GSM4304665","GSM4304666","GSM4304667","GSM4304668","GSM4304669","GSM4304670","GSM4304671","GSM4304672",
"GSM4304673","GSM4304674","GSM4304675","GSM4304676","GSM4304677","GSM4304678","GSM4304679","GSM4304680","GSM4304681","GSM4308688","GSM4308689","GSM4308690","GSM4308691","GSM4308692","GSM4308693","GSM4308694","GSM4308695","GSM4308696","GSM4308697","GSM4308698","GSM4308699","GSM4308700","GSM4308701","GSM4520717","GSM4520718","GSM4520719","GSM4520721","GSM4520722","GSM4520723","GSM4520724",
"GSM4520725","GSM4520726","GSM4520727","GSM4520728","GSM4520729","GSM4520730","GSM4520731","GSM4646431","GSM4646432","GSM4646433","GSM4646434","GSM4646435","GSM4646436","GSM4646437","GSM4646438","GSM3591480","GSM4155574","GSM4226038","GSM4226101","GSM4304682","GSM4563829","GSM4563830","GSM4563831","GSM4563832","GSM4563833","GSM4563834","GSM4563835","GSM4563836","GSM4563837","GSM4563838",
"GSM4563839","GSM4563840","GSM4671849","GSM4671850","GSM4671851","GSM4671852","GSM4671853","GSM4671854","GSM4648029","GSM4648030","GSM4648031","GSM4648032","GSM4648033","GSM4648034","GSM4648035","GSM4648085","GSM4648087","GSM4648088","GSM4648089","GSM4648090","GSM4648091","GSM4648092","GSM4668813","GSM4668814","GSM4668815","GSM4715411","GSM4715412","GSM4715414","GSM4756845","GSM4756846",
"GSM4756847","GSM4756848","GSM4756849","GSM4756850","GSM4756851","GSM4756852","GSM4756853","GSM4756854","GSM4756855","GSM4756856","GSM5269610","GSM5269611","GSM5269614","GSM5269618","GSM5269621","GSM5269623","GSM5269628","GSM5269634","GSM5269635","GSM5269640","GSM5269641","GSM5269643","GSM5414227","GSM5414228","GSM5414237","GSM5414238","GSM5515760","GSM5515761","GSM5515762","GSM5515763",
"GSM5515764","GSM5515765","")

# Retrieve information from compressed data
samples = h5read(destination_file, "meta/samples/geo_accession")
genes = h5read(destination_file, "meta/genes/genes")

# Identify columns to be extracted
sample_locations = which(samples %in% samp)

# extract gene expression from compressed data
expression = t(h5read(destination_file, "data/expression", index=list(sample_locations, 1:length(genes))))
H5close()
rownames(expression) = genes
colnames(expression) = samples[sample_locations]

# Print file
write.table(expression, file=extracted_expression_file, sep="\t", quote=FALSE, col.names=NA)
print(paste0("Expression file was created at ", getwd(), "/", extracted_expression_file))

