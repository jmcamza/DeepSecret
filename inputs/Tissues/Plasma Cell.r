# R script to download selected samples
# Copy code and run on a local machine to initiate download

library("rhdf5")    # can be installed using Bioconductor

destination_file = "human_matrix_v10.h5"
extracted_expression_file = "Plasma Cell_expression_matrix.tsv"
url = "https://s3.amazonaws.com/mssm-seq-matrix/human_matrix_v10.h5"

# Check if gene expression file was already downloaded, if not in current directory download file form repository
if(!file.exists(destination_file)){
    print("Downloading compressed gene expression matrix.")
    download.file(url, destination_file, quiet = FALSE, mode = 'wb')
}

# Selected samples to be extracted
samp = c("GSM2171213","GSM2171215","GSM2171214","GSM2197432","GSM2171212","GSM2197433","GSM2197434","GSM2197431","GSM3533224","GSM3533225","GSM3533226","GSM3350529","GSM3350530","GSM3350531","GSM3350532","GSM3350533","GSM3350534","GSM3350535","GSM3350537","GSM3350538","GSM3350539","GSM3350540","GSM3350541","GSM3350542","GSM3350543","GSM3350544","GSM3350545","GSM3350546","GSM3350547","GSM3350548","GSM3350549",
"GSM3350550","GSM3350551","GSM3350552","GSM3350553","GSM3350554","GSM3350555","GSM3350556","GSM3350557","GSM3350558","GSM3350559","GSM3350560","GSM3350561","GSM3350562","GSM3350564","GSM3350565","GSM3350567","GSM3350568","GSM3350569","GSM3350570","GSM3350571","GSM3350572","GSM3350573","GSM3350574","GSM3350575","GSM3350576","GSM3350577","GSM3350578","GSM3350579","GSM3350580","GSM3350581",
"GSM3350582","GSM3350583","GSM3350584","GSM3350585","GSM3350586","GSM3350587","GSM3350588","GSM3350589","GSM3350590","GSM3350591","GSM3350592","GSM3350593","GSM3350594","GSM3350595","GSM3350596","GSM3350597","GSM3350598","GSM3350599","GSM3350600","GSM3350601","GSM3350602","GSM3350603","GSM3350604","GSM3350605","GSM3350606","GSM3350607","GSM3350608","GSM3350609","GSM3350610","GSM3350611",
"GSM3350612","GSM3350613","GSM3350614","GSM3350615","GSM3350616","GSM3350617","GSM3350618","GSM3350619","GSM3350620","GSM3350621","GSM3350622","GSM3350623","GSM3350624","GSM3350625","GSM3350626","GSM3350627","GSM3350628","GSM3350630","GSM3350631","GSM3350632","GSM3350633","GSM3350634","GSM3350635","GSM3350636","GSM3350637","GSM3350638","GSM3350639","GSM3350640","GSM3350641","GSM3350642",
"GSM3350643","GSM3350644","GSM3350645","GSM3350646","GSM3350647","GSM3350648","GSM3350649","GSM3350650","GSM3350651","GSM3350652","GSM3350653","GSM3350654","GSM3350655","GSM3350656","GSM3350657","GSM3350658","GSM3350659","GSM3350660","GSM3350661","GSM3350662","GSM3350663","GSM3350664","GSM3350665","GSM3350666","GSM3350667","GSM3350668","GSM3350669","GSM3350670","GSM3350671","GSM3350672",
"GSM3350673","GSM3350674","GSM3350675","GSM3350676","GSM3350677","GSM3350678","GSM3350679","GSM3350680","GSM3350681","GSM3350682","GSM3350683","GSM3350684","GSM3350685","GSM3350686","GSM3350687","GSM3350688","GSM3350689","GSM3350690","GSM3350691","GSM3350692","GSM3350693","GSM3350694","GSM3350695","GSM3350696","GSM3350697","GSM3350698","GSM3350699","GSM3350700","GSM3350701","GSM3350702",
"GSM3350703","GSM3350704","GSM3350705","GSM3350706","GSM3350707","GSM3350708","GSM3350709","GSM3350710","GSM3350711","GSM3350712","GSM3350713","GSM3350714","GSM3350715","GSM3350716","GSM3350717","GSM3350718","GSM3350719","GSM3350720","GSM3350721","GSM3350722","GSM3350723","GSM3350724","GSM3350725","GSM3350726","GSM3350727","GSM3350728","GSM3350729","GSM3350730","GSM3350731","GSM3350732",
"GSM3350733","GSM3350734","GSM3350735","GSM3350736","GSM3350737","GSM3350738","GSM3350739","GSM3350740","GSM3350741","GSM3350742","GSM3350743","GSM3350744","GSM3350745","GSM3350746","GSM3350747","GSM3350748","GSM3350749","GSM3350750","GSM3350751","GSM3350752","GSM3350753","GSM3350754","GSM3350755","GSM3350756","GSM3350757","GSM3350758","GSM3350759","GSM3350760","GSM3350761","GSM3350762",
"GSM3350763","GSM3350764","GSM3350765","GSM3350766","GSM3350767","GSM3350768","GSM3350769","GSM3350770","GSM3350771","GSM3350773","GSM3350774","GSM3350775","GSM3350776","GSM3350777","GSM3350778","GSM3350779","GSM3350780","GSM3350781","GSM3350782","GSM3350783","GSM3350784","GSM3350785","GSM3350786","GSM3350787","GSM3350788","GSM3350789","GSM3350790","GSM3350791","GSM3350792","GSM3350793",
"GSM3350794","GSM3350795","GSM3350796","GSM3350797","GSM3350798","GSM3350799","GSM3350800","GSM3350801","GSM3350802","GSM3350803","GSM3350804","GSM3350805","GSM3350806","GSM3350807","GSM3350808","GSM3350809","GSM3350810","GSM3350811","GSM3350812","GSM3350813","GSM3350814","GSM3350815","GSM3350816","GSM3350817","GSM3350818","GSM3350819","GSM3350820","GSM3350821","GSM3350822","GSM3350823",
"GSM3350824","GSM3350825","GSM3350826","GSM3350827","GSM3350828","GSM3350829","GSM3350830","GSM3350831","GSM3350832","GSM3350833","GSM3350834","GSM3350835","GSM3350836","GSM3350837","GSM3350838","GSM3350839","GSM3350840","GSM3350841","GSM3350842","GSM3350843","GSM3350844","GSM3350845","GSM3350846","GSM3350847","GSM3350848","GSM3350849","GSM3350850","GSM3350851","GSM3350852","GSM3350853",
"GSM3350854","GSM3350855","GSM3350856","GSM3350857","GSM3350858","GSM3350859","GSM3350860","GSM3350861","GSM3350862","GSM3350863","GSM3350864","GSM3350865","GSM3350866","GSM3350867","GSM3350868","GSM3350869","GSM3350870","GSM3350871","GSM3350872","GSM3350873","GSM3350874","GSM3350875","GSM3350876","GSM3350877","GSM3350878","GSM3350879","GSM3350880","GSM3350881","GSM3350882","GSM3350883",
"GSM3350884","GSM3350885","GSM3350886","GSM3350887","GSM3350888","GSM3350889","GSM3350890","GSM3350891","GSM3350892","GSM3350893","GSM3350894","GSM3350895","GSM3350896","GSM3350897","GSM3350898","GSM3350899","GSM3350900","GSM3350901","GSM3350902","GSM3350903","GSM3350904","GSM3350905","GSM3350907","GSM3350908","GSM3350909","GSM3350910","GSM3350911","GSM3350912","GSM3350913","GSM3350914",
"GSM3350915","GSM3350916","GSM3350918","GSM3350919","GSM3350920","GSM3350921","GSM3350922","GSM3350923","GSM3350924","GSM3350925","GSM3350926","GSM3350927","GSM3350928","GSM3350929","GSM3350930","GSM3350931","GSM3350932","GSM3350933","GSM3350934","GSM3350935","GSM3350936","GSM3350937","GSM3350938","GSM3350939","GSM3350940","GSM3350941","GSM3350942","GSM3350943","GSM3350944","GSM3350945",
"GSM3350946","GSM3350947","GSM3350948","GSM3350949","GSM3350950","GSM3350951","GSM3350952","GSM3350953","GSM3350954","GSM3350955","GSM3350956","GSM3350957","GSM3350958","GSM3350959","GSM3350960","GSM3350961","GSM3350962","GSM3350963","GSM3350964","GSM3350965","GSM3350966","GSM3350967","GSM3350968","GSM3350969","GSM3350970","GSM3350971","GSM3350972","GSM3350973","GSM3350974","GSM3350975",
"GSM3350976","GSM3350977","GSM3350978","GSM3350979","GSM3350980","GSM3350981","GSM3350982","GSM3350983","GSM3350984","GSM3350985","GSM3350986","GSM3350987","GSM3350988","GSM3350989","GSM3350990","GSM3350991","GSM3350992","GSM3350993","GSM3350994","GSM3350995","GSM3350996","GSM3350997","GSM3350998","GSM3350999","GSM3351000","GSM3351001","GSM3351002","GSM3351003","GSM3351004","GSM3351005",
"GSM3351006","GSM3351007","GSM3351008","GSM3351009","GSM3351010","GSM3351011","GSM3351012","GSM3351013","GSM3351014","GSM3351015","GSM3351016","GSM3351017","GSM3351018","GSM3351019","GSM3351020","GSM3351021","GSM3351022","GSM3351023","GSM3351024","GSM3351025","GSM3351026","GSM3351027","GSM3351028","GSM3351029","GSM3351030","GSM3351031","GSM3351032","GSM3351033","GSM3351034","GSM3351035",
"GSM3351036","GSM3351037","GSM3351038","GSM3351039","GSM3351040","GSM3351041","GSM3351042","GSM3351043","GSM3351044","GSM3351045","GSM3351046","GSM3351047","GSM3351048","GSM3351049","GSM3351050","GSM3351051","GSM3351052","GSM3351053","GSM3351054","GSM3351055","GSM3351056","GSM3351057","GSM3351058","GSM3351059","GSM3351060","GSM3351061","GSM3351062","GSM3351063","GSM3351064","GSM3351065",
"GSM3351066","GSM3351067","GSM3351068","GSM3351069","GSM3351070","GSM3351071","GSM3351072","GSM3351073","GSM3351074","GSM3351075","GSM3351076","GSM3351077","GSM3351078","GSM3351079","GSM3351080","GSM3351081","GSM3351082","GSM3351083","GSM3351084","GSM3351085","GSM3351086","GSM3351087","GSM3351088","GSM3351089","GSM3351090","GSM3351091","GSM3351092","GSM3351093","GSM3351094","GSM3351095",
"GSM3351096","GSM3351097","GSM3351098","GSM3351099","GSM3351100","GSM3351101","GSM3351102","GSM3351103","GSM3351104","GSM3351105","GSM3351106","GSM3351107","GSM3351108","GSM3351109","GSM3351110","GSM3351111","GSM3351112","GSM3351113","GSM3351114","GSM3351115","GSM3351116","GSM3351117","GSM3351118","GSM3351119","GSM3351120","GSM3351121","GSM3351122","GSM3351123","GSM3351124","GSM3573351",
"GSM3573352","GSM3573353","GSM3573354","GSM3573355","GSM3573356","GSM3573357","GSM3573358","GSM3573359","GSM4565590","GSM4565591","GSM4565592","GSM4565593","GSM4565594","GSM4565595","GSM4565596","GSM4565597","GSM4565598","GSM4565599","GSM4565600","GSM4565601","GSM4565602","GSM4565603","GSM4565604","GSM4565605","GSM4565606","GSM4565607","GSM4565608","GSM4565609","GSM4565610","GSM4565611",
"GSM4565612","GSM4565613","GSM4565614","GSM4565615","GSM4565616","GSM4565617","GSM4565618","GSM4565619","GSM4565620","GSM4565621","GSM4565622","GSM4565623","GSM4565624","GSM4565625","GSM4565626","GSM4565627","GSM3935027","GSM3935028","GSM3935029","GSM3935030","GSM4419546","GSM4419547","GSM4419548","GSM4419549","GSM4419551","GSM4419552","GSM4419553","GSM4419554","GSM4419555","GSM4419556",
"GSM4419558","GSM4419561","GSM4419562","GSM4419563","GSM4419564","GSM4419565","GSM4419566","GSM4419567","GSM4419568","GSM4419569","GSM4419570","GSM4419571","GSM4419572","GSM4419573","GSM4419574","GSM4419575","GSM4419576","GSM4419577","GSM4419578","GSM4419579","GSM4419580","GSM4419581","GSM4419582","GSM4419583","GSM4419585","GSM4419586","GSM4419588","GSM4419589","GSM4419590","GSM4419591",
"GSM4419592","GSM4419593","GSM4419594","GSM4419595","GSM4419598","GSM4419599","GSM4419600","GSM4419601","GSM4419602","GSM4419603","GSM4419604","GSM4419605","GSM4419607","GSM4419608","GSM4419609","GSM4419610","GSM4419611","GSM4419613","GSM4419614","GSM4419615","GSM4419616","GSM4419618","GSM4419619","GSM4419620","GSM4419621","GSM4419622","GSM4419623","GSM4419624","GSM4419625","GSM4419626",
"GSM4419627","GSM4419628","GSM4419629","GSM4643259","GSM4643260","GSM4643261","GSM4643262","GSM4643264","GSM4643265","GSM4643266","GSM4643267","GSM4643270","GSM4643273","GSM4643274","GSM4643275","GSM4643277","GSM4643278","GSM4643283","GSM4643290","")

# Retrieve information from compressed data
samples = h5read(destination_file, "meta/samples/geo_accession")
genes = h5read(destination_file, "meta/genes/genes")

# Identify columns to be extracted
sample_locations = which(samples %in% samp)

# extract gene expression from compressed data
expression = t(h5read(destination_file, "data/expression", index=list(sample_locations, 1:length(genes))))
H5close()
rownames(expression) = genes
colnames(expression) = samples[sample_locations]

# Print file
write.table(expression, file=extracted_expression_file, sep="\t", quote=FALSE, col.names=NA)
print(paste0("Expression file was created at ", getwd(), "/", extracted_expression_file))

