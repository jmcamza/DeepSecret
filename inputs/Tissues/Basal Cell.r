# R script to download selected samples
# Copy code and run on a local machine to initiate download

library("rhdf5")    # can be installed using Bioconductor

destination_file = "human_matrix_v10.h5"
extracted_expression_file = "Basal Cell_expression_matrix.tsv"
url = "https://s3.amazonaws.com/mssm-seq-matrix/human_matrix_v10.h5"

# Check if gene expression file was already downloaded, if not in current directory download file form repository
if(!file.exists(destination_file)){
    print("Downloading compressed gene expression matrix.")
    download.file(url, destination_file, quiet = FALSE, mode = 'wb')
}

# Selected samples to be extracted
samp = c("GSM1155381","GSM1155383","GSM1155386","GSM1155377","GSM1194693","GSM1194694","GSM1155376","GSM1155385","GSM1155370","GSM1155379","GSM1155380","GSM1155382","GSM1155371","GSM1155384","GSM1194687","GSM1155372","GSM1155378","GSM1155375","GSM1155374","GSM1155373","GSM1930429","GSM1930419","GSM1930421","GSM1930420","GSM1638210","GSM1930428","GSM1930430","GSM1638211","GSM1638209","GSM1409345","GSM1409343",
"GSM1409342","GSM1409352","GSM1409349","GSM1409351","GSM1409346","GSM1409347","GSM1409353","GSM1409344","GSM1409354","GSM1409350","GSM1409348","GSM1981334","GSM1981335","GSM1981336","GSM1981337","GSM1981338","GSM1981339","GSM1981340","GSM1981341","GSM1981342","GSM1981343","GSM1981344","GSM1981345","GSM1981346","GSM1981347","GSM1981348","GSM1981349","GSM1981350","GSM2276638","GSM2276639",
"GSM2276640","GSM2276641","GSM2276642","GSM2276643","GSM2276644","GSM2276645","GSM2276646","GSM2276647","GSM2011215","GSM2011216","GSM2011217","GSM2011218","GSM2011219","GSM2011220","GSM2011221","GSM2011222","GSM2292796","GSM2292797","GSM2292798","GSM2292799","GSM2292800","GSM2292801","GSM2292802","GSM2292803","GSM2292804","GSM2292805","GSM2292806","GSM2292807","GSM2292808","GSM2292809",
"GSM2292810","GSM2292811","GSM2292812","GSM2292813","GSM2292814","GSM2292815","GSM2292839","GSM2292840","GSM2292841","GSM2576304","GSM2576305","GSM2576306","GSM2576307","GSM2576308","GSM2576309","GSM2576310","GSM2576311","GSM2576312","GSM2649095","GSM2649096","GSM2649097","GSM2649098","GSM2649099","GSM2649100","GSM2649101","GSM2649102","GSM2649103","GSM2649104","GSM2649105","GSM2649106",
"GSM2649107","GSM3017120","GSM3017121","GSM3017122","GSM3098012","GSM3098013","GSM3098014","GSM3098015","GSM3098016","GSM3098017","GSM3098018","GSM3098019","GSM3098020","GSM3098021","GSM3098022","GSM3098023","GSM3098024","GSM3098025","GSM3098026","GSM3098027","GSM3098028","GSM3098029","GSM3098030","GSM3098031","GSM3098032","GSM3098033","GSM3098034","GSM3098035","GSM3098036","GSM3098037",
"GSM3098038","GSM3098039","GSM3098040","GSM3098041","GSM3098042","GSM3098043","GSM3098044","GSM3098045","GSM3098046","GSM3098047","GSM3098048","GSM3098049","GSM3098050","GSM3098051","GSM3098052","GSM3098053","GSM3098054","GSM3098055","GSM3098056","GSM3098057","GSM3098058","GSM3098059","GSM3511735","GSM3511736","GSM3511737","GSM3511738","GSM3511739","GSM3511740","GSM3511741","GSM3511742",
"GSM3511743","GSM3511746","GSM3511747","GSM3511748","GSM3511749","GSM3511750","GSM3511751","GSM3511752","GSM3511753","GSM3511754","GSM3511755","GSM3511756","GSM3511757","GSM3511758","GSM3511759","GSM3511760","GSM3511761","GSM3511762","GSM3511763","GSM3511764","GSM3511768","GSM3721445","GSM3721446","GSM3721447","GSM3721448","GSM3721449","GSM3721450","GSM3721459","GSM3721460","GSM3721465",
"GSM3721466","GSM3721467","GSM3721470","GSM3721476","GSM3721477","GSM3511765","GSM3511766","GSM3511767","GSM3526500","GSM3526501","GSM2701641","GSM2701642","GSM2701643","GSM2701644","GSM2701645","GSM2701646","GSM2701647","GSM2701648","GSM2701649","GSM2701650","GSM2701651","GSM2701652","GSM2701653","GSM2701654","GSM2701655","GSM2701656","GSM2701657","GSM2701658","GSM2701659","GSM2701660",
"GSM2701661","GSM2701662","GSM2701663","GSM2701664","GSM2701665","GSM2701666","GSM2701667","GSM2701668","GSM2701669","GSM2701670","GSM2701671","GSM2701672","GSM2701673","GSM2701674","GSM2701675","GSM2701676","GSM2701677","GSM2701678","GSM2701679","GSM2701699","GSM2711168","GSM2711169","GSM4205686","GSM4205687","GSM4205688","GSM4205689","GSM4483232","GSM4483233","GSM4483234","GSM4483235",
"GSM4483236","GSM4483237","GSM4483238","GSM4483239","GSM4483240","GSM4483241","GSM4483242","GSM4483243","GSM4725965","GSM4725966","GSM4725967","GSM4725969","GSM4725972","GSM4725977","GSM4725978","GSM4725979","GSM4725981","GSM4725982","GSM4725984","GSM4725990","GSM4725992","GSM5253429","GSM5253430","GSM5253431","GSM5253432","GSM5253433","GSM5253434","GSM5253435","GSM5253436","GSM5253437",
"GSM5253438","GSM5253439","GSM5253440","GSM5253441","GSM5253442","GSM5253443","GSM5253444","GSM5253445","GSM5253446","GSM5253447","GSM5253448","GSM5253449","GSM5253450","GSM5253451","GSM5253452","GSM5253453","GSM5253454","GSM5253455","GSM5253456","GSM5253457","GSM5253458","GSM5253459","GSM5253460","GSM5253461","GSM5253462","GSM5253463","GSM5253464","GSM5253465","GSM5253466","GSM5253467",
"GSM5253468","GSM5253469","GSM5253470","GSM5253471","GSM5253472","GSM5253473","GSM5253474","GSM5253475","GSM5253476","GSM5253477","GSM5253478","GSM5253479","GSM5253480","GSM5253481","GSM5253482","GSM5253483","GSM5253484","GSM5253485","GSM5253486","GSM5253487","GSM5253488","GSM5253489","GSM5253490","GSM5253491","GSM5253492","GSM5253493","GSM5253494","GSM5253495","GSM5253496","GSM5253497",
"GSM5253499","GSM5253500","GSM5253501","GSM5253502","GSM5253503","GSM5253504","GSM5253505","GSM5253506","GSM5253507","GSM5253508","GSM5253509","GSM5253510","GSM5253511","GSM5253512","GSM5253513","GSM5253514","GSM5253515","GSM5253516","GSM5253517","GSM5253518","GSM5253519","GSM5253520","GSM5253521","GSM5253522","GSM5253523","GSM5253524","GSM5253525","GSM5253526","GSM5253527","GSM5253528",
"GSM5253529","GSM5253530","GSM5253531","GSM5253532","GSM5253533","GSM5253534","GSM5253535","GSM5253536","GSM5253537","GSM5253538","GSM5253539","GSM5253540","GSM5253541","GSM5253542","GSM5253543","GSM5253544","GSM5253545","GSM5253546","GSM5253547","GSM5253548","GSM5253549","GSM5253550","GSM5253551","GSM5253552","GSM5253553","GSM5253554","GSM5253555","GSM5253556","GSM5253557","GSM5253558",
"GSM5253559","GSM5253560","GSM5253561","GSM5253562","GSM5253563","GSM5253564","GSM5253565","GSM5253566","GSM5253567","GSM5253568","GSM5253570","GSM5253571","GSM5253572","GSM5253573","GSM5253575","GSM5253577","GSM5253579","GSM5253580","GSM5253581","GSM5253582","GSM5253583","GSM5253585","GSM5253586","GSM5253589","GSM5253590","GSM5253591","GSM5253592","GSM5253593","GSM5253594","GSM5253595",
"GSM5253596","GSM5253597","GSM5253598","GSM5253599","GSM5253600","GSM5253601","GSM5253602","GSM5253603","GSM5253604","GSM5253605","GSM5253606","GSM5253607","GSM5253608","GSM5253609","GSM5253610","GSM5253611","GSM5253612","GSM5253615","GSM5253616","GSM5253617","GSM5253618","")

# Retrieve information from compressed data
samples = h5read(destination_file, "meta/samples/geo_accession")
genes = h5read(destination_file, "meta/genes/genes")

# Identify columns to be extracted
sample_locations = which(samples %in% samp)

# extract gene expression from compressed data
expression = t(h5read(destination_file, "data/expression", index=list(sample_locations, 1:length(genes))))
H5close()
rownames(expression) = genes
colnames(expression) = samples[sample_locations]

# Print file
write.table(expression, file=extracted_expression_file, sep="\t", quote=FALSE, col.names=NA)
print(paste0("Expression file was created at ", getwd(), "/", extracted_expression_file))

