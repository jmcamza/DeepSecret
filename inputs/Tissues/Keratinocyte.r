# R script to download selected samples
# Copy code and run on a local machine to initiate download

library("rhdf5")    # can be installed using Bioconductor

destination_file = "human_matrix_v10.h5"
extracted_expression_file = "Keratinocyte_expression_matrix.tsv"
url = "https://s3.amazonaws.com/mssm-seq-matrix/human_matrix_v10.h5"

# Check if gene expression file was already downloaded, if not in current directory download file form repository
if(!file.exists(destination_file)){
    print("Downloading compressed gene expression matrix.")
    download.file(url, destination_file, quiet = FALSE, mode = 'wb')
}

# Selected samples to be extracted
samp = c("GSM1245061","GSM869033","GSM1245062","GSM869035","GSM869034","GSM1540466","GSM1540462","GSM1446886","GSM1540465","GSM1540463","GSM1540461","GSM1540464","GSM1634327","GSM1446885","GSM2284160","GSM2284158","GSM1634326","GSM2284157","GSM1446887","GSM1446884","GSM2284156","GSM2284161","GSM1634328","GSM1446881","GSM1446883","GSM1446882","GSM2284159","GSM1632435","GSM1446880","GSM1890540","GSM1890538",
"GSM1890539","GSM1890535","GSM1890537","GSM1890536","GSM2031990","GSM2031986","GSM2031991","GSM2031987","GSM2031985","GSM2031984","GSM2031989","GSM2031983","GSM2031982","GSM2031988","GSM2072575","GSM2072576","GSM2268320","GSM2268322","GSM2268321","GSM2268319","GSM2268323","GSM2268318","GSM2247317","GSM2247318","GSM2247319","GSM2247320","GSM2247321","GSM2247322","GSM2720262","GSM2720263",
"GSM2720264","GSM2720265","GSM2720266","GSM2720267","GSM2935054","GSM2935055","GSM2935056","GSM2935057","GSM2991609","GSM2991610","GSM2991611","GSM2991612","GSM2991613","GSM2991614","GSM2991615","GSM2991616","GSM2991617","GSM2991618","GSM2991619","GSM2991620","GSM2536369","GSM2536370","GSM2536371","GSM2536372","GSM2536408","GSM2536409","GSM2536410","GSM2536411","GSM2536412","GSM2536413",
"GSM2536414","GSM2536415","GSM2536416","GSM2536417","GSM2536418","GSM2536419","GSM3192753","GSM3192756","GSM2781307","GSM2781308","GSM2781309","GSM2781310","GSM2781311","GSM2781312","GSM2781313","GSM2781314","GSM2781315","GSM2781316","GSM2781317","GSM2781318","GSM2781319","GSM2781320","GSM3303935","GSM3303936","GSM3303937","GSM3303938","GSM3303939","GSM3303940","GSM3440262","GSM3440263",
"GSM3440264","GSM3440265","GSM3440266","GSM3440267","GSM3440268","GSM3440269","GSM3427501","GSM3427502","GSM3427503","GSM3427504","GSM3427505","GSM3427506","GSM3427507","GSM3427508","GSM3427509","GSM3427510","GSM3449772","GSM3449773","GSM3449774","GSM3449775","GSM3449776","GSM3449777","GSM3449778","GSM3449779","GSM3449780","GSM3449781","GSM3449782","GSM3449783","GSM3449784","GSM3449785",
"GSM3449786","GSM3449787","GSM3559668","GSM3559669","GSM3559670","GSM3559671","GSM3559672","GSM3559673","GSM3559674","GSM3559675","GSM3559676","GSM3559677","GSM3559678","GSM3559679","GSM3559680","GSM3559681","GSM3559682","GSM3559683","GSM3559684","GSM3559685","GSM3559686","GSM3559687","GSM3559688","GSM3559689","GSM3559690","GSM3559691","GSM3559692","GSM3559693","GSM3559694","GSM3559695",
"GSM3559696","GSM3559697","GSM3559698","GSM3559699","GSM3559700","GSM3559701","GSM3559702","GSM3559703","GSM3559704","GSM3559705","GSM3559706","GSM3559707","GSM3559708","GSM3559709","GSM3559710","GSM3559711","GSM3559712","GSM3559713","GSM3559714","GSM3559715","GSM3559716","GSM3559717","GSM3559718","GSM3559719","GSM3559720","GSM3559721","GSM3559722","GSM3559723","GSM3559724","GSM3559725",
"GSM3559726","GSM3559727","GSM3559728","GSM3559729","GSM3559730","GSM3559731","GSM3559732","GSM3559733","GSM3559734","GSM3559735","GSM3559736","GSM3559737","GSM3559738","GSM3559739","GSM2597280","GSM2597281","GSM2597282","GSM2597283","GSM2597284","GSM2597285","GSM2597286","GSM2597287","GSM3140552","GSM3140553","GSM3191999","GSM3192000","GSM3192001","GSM3192002","GSM3192003","GSM3192004",
"GSM3193388","GSM3193389","GSM3193390","GSM3193391","GSM3193392","GSM3193393","GSM3193394","GSM3193395","GSM3195601","GSM3195602","GSM3195603","GSM3195604","GSM3195605","GSM3195606","GSM3195607","GSM3195608","GSM3195609","GSM3195610","GSM3453030","GSM3453031","GSM3453032","GSM3453033","GSM2753006","GSM2753007","GSM2753008","GSM2753009","GSM2753010","GSM2753011","GSM2753012","GSM2753013",
"GSM2753014","GSM3444166","GSM3704454","GSM3704455","GSM3704458","GSM3704459","GSM3704462","GSM3704463","GSM3926256","GSM3926257","GSM3926258","GSM3926259","GSM3926260","GSM3926261","GSM3926262","GSM3926263","GSM3926264","GSM3926265","GSM3926266","GSM3926267","GSM3926268","GSM3926269","GSM3926270","GSM3926271","GSM3926272","GSM3926273","GSM3926274","GSM3926275","GSM3926276","GSM3926277",
"GSM3926278","GSM3926279","GSM3926280","GSM3926281","GSM4095203","GSM4095204","GSM4095205","GSM4095206","GSM4095207","GSM4095208","GSM4095209","GSM4095210","GSM4095211","GSM4095212","GSM4095213","GSM4095214","GSM4095215","GSM4095216","GSM4095217","GSM3393716","GSM3393717","GSM3852106","GSM3852107","GSM3852108","GSM3852109","GSM3852110","GSM3852111","GSM3852112","GSM3852113","GSM3852114",
"GSM4025821","GSM4025822","GSM4025823","GSM4025824","GSM4025825","GSM4025826","GSM3788533","GSM3788534","GSM3788535","GSM3788536","GSM3788537","GSM3788538","GSM2976411","GSM2976412","GSM2976413","GSM2976414","GSM2976415","GSM2976416","GSM3369898","GSM3369899","GSM3369900","GSM3369901","GSM3369902","GSM3369903","GSM3369904","GSM3369905","GSM3369906","GSM3369907","GSM3369908","GSM3369909",
"GSM3369910","GSM3369911","GSM3369912","GSM3369913","GSM3369914","GSM3369915","GSM3369916","GSM3369918","GSM3625480","GSM3625481","GSM3625482","GSM3625483","GSM3625484","GSM3625485","GSM3913617","GSM3913618","GSM3913619","GSM3913620","GSM3913621","GSM3913622","GSM3913623","GSM3913624","GSM3913625","GSM3913626","GSM3913627","GSM3913628","GSM3913629","GSM3913630","GSM3913631","GSM3913632",
"GSM3913633","GSM3913634","GSM3913635","GSM3913636","GSM3913637","GSM3913638","GSM3913639","GSM3913640","GSM4078731","GSM4078732","GSM4078733","GSM4078734","GSM4078735","GSM4078736","GSM4078737","GSM4081382","GSM4081383","GSM4081384","GSM4081385","GSM4081386","GSM4081387","GSM4081388","GSM4093599","GSM4093600","GSM4093601","GSM4093602","GSM4154288","GSM4154289","GSM4154290","GSM4154291",
"GSM4192039","GSM4192040","GSM4192041","GSM4192042","GSM4192043","GSM4192044","GSM4192045","GSM4192046","GSM4192047","GSM4192048","GSM4192049","GSM4192050","GSM4202173","GSM4202175","GSM4202176","GSM4202177","GSM4202178","GSM4202179","GSM4202180","GSM4202181","GSM4202182","GSM4202183","GSM4223375","GSM4223376","GSM4223377","GSM4223378","GSM4223379","GSM4223380","GSM4261149","GSM4261150",
"GSM4261151","GSM4261152","GSM4261153","GSM4261154","GSM4261155","GSM4261156","GSM4261157","GSM4486936","GSM4486937","GSM4486938","GSM4486939","GSM4486940","GSM4486941","GSM4486942","GSM4486943","GSM4486944","GSM4486945","GSM4568364","GSM4568365","GSM4568366","GSM4568367","GSM4568368","GSM4568369","GSM4568370","GSM4665269","GSM4665270","GSM4665271","GSM4665272","GSM4665273","GSM4665274",
"GSM4202174","GSM4367911","GSM4367912","GSM4367913","GSM4367914","GSM4367915","GSM4367916","GSM4367918","GSM4367919","GSM4367920","GSM4367921","GSM4367922","GSM4367923","GSM4367924","GSM4367925","GSM4459711","GSM4459712","GSM4459713","GSM4459714","GSM4459715","GSM4459716","GSM4459717","GSM4459718","GSM4459719","GSM4459720","GSM4459721","GSM4459722","GSM4459723","GSM4459724","GSM4543342",
"GSM4543343","GSM4543344","GSM4543345","GSM4543346","GSM4543347","GSM4543348","GSM4543349","GSM4543350","GSM4594216","GSM4594217","GSM4594218","GSM4594219","GSM4594220","GSM4594221","GSM4594222","GSM4594223","GSM4594224","GSM4594226","GSM4693851","GSM4693852","GSM4693853","GSM4693854","GSM4693855","GSM4693856","GSM4693857","GSM4693858","GSM4693859","GSM4693860","GSM4693861","GSM4693862",
"GSM4693863","GSM4693864","GSM4693865","GSM4709914","GSM4709915","GSM4709916","GSM4709917","GSM4711950","GSM4711951","GSM4711952","GSM4711953","GSM4711954","GSM4711955","GSM4711956","GSM4711957","GSM4711958","GSM4711959","GSM4885911","GSM4885912","GSM4885913","GSM4885914","GSM4885916","GSM4885917","GSM4885919","GSM4885920","GSM4885922","GSM4885923","GSM4885926","GSM4885927","GSM4885928",
"GSM4885929","GSM4885930","GSM4885931","GSM4976933","GSM4976934","GSM4976935","GSM4976936","GSM4976937","GSM4976938","GSM4976939","GSM4976940","GSM4976941","GSM4976942","GSM2700438","GSM2700439","GSM2700440","GSM2700441","GSM2700442","GSM2700443","GSM2700444","GSM2700446","GSM2700447","GSM2700448","GSM2700449","GSM2700450","GSM2700452","GSM2700454","GSM2700456","GSM2700457","GSM2700459",
"GSM2700461","GSM2700462","GSM2700463","GSM2700464","GSM2700465","GSM2700466","GSM2700467","GSM2700468","GSM2700469","GSM3711404","GSM3711405","GSM3711406","GSM3711407","GSM3711408","GSM3711409","GSM3738985","GSM3738986","GSM3738987","GSM3738988","GSM3738989","GSM3738990","GSM3738991","GSM3738992","GSM3738993","GSM3738994","GSM3738995","GSM3738997","GSM3738998","GSM3738999","GSM3739000",
"GSM3891871","GSM3891873","GSM3891874","GSM3891875","GSM3891876","GSM3891877","GSM3891878","GSM3891879","GSM3891881","GSM3891882","GSM3891883","GSM3891884","GSM3891885","GSM3891888","GSM3891889","GSM3891891","GSM3891894","GSM3891897","GSM3891899","GSM3891900","GSM3891901","GSM3891903","GSM3891904","GSM3891905","GSM3891906","GSM3891907","GSM3891908","GSM3891909","GSM3891910","GSM3891911",
"GSM3891914","GSM3891915","GSM3891917","GSM4117548","GSM4117550","GSM4117551","GSM4117553","GSM4117554","GSM4117555","GSM4117556","GSM4117593","GSM4117595","GSM4117611","GSM4117613","GSM4434940","GSM4434941","GSM4434942","GSM4434944","GSM4434945","GSM4434947","GSM4602861","GSM4602862","GSM4602864","GSM4602865","GSM4634681","GSM4634682","GSM4634684","GSM4634686","GSM4685061","GSM4685062",
"GSM4685063","GSM4685064","GSM4685065","GSM4685066","GSM4700233","GSM4700234","GSM4700236","GSM4700237","GSM4700238","GSM4700239","GSM4700240","GSM4700241","GSM4700242","GSM4700243","GSM4700244","GSM4700246","GSM4700247","GSM4700248","GSM4700249","GSM4712539","GSM4712540","GSM4824577","GSM4824578","GSM4838840","GSM4838841","GSM4838842","GSM4838843","GSM4838844","GSM4838845","GSM4838846",
"GSM4838847","GSM4838848","GSM4838849","GSM4838850","GSM4838851","GSM5124394","GSM5124395","GSM5124396","GSM5124397","GSM5124398","GSM5124399","GSM5124401","GSM5331387","GSM5369491","GSM5369492","GSM5375400","GSM5396281","GSM5396282","GSM5396283","GSM5396284","GSM5396285","GSM5396286","GSM5396288","GSM5396289","GSM5396290","GSM5396291","GSM5501984","GSM5501988","GSM5502005","GSM5502009",
"")

# Retrieve information from compressed data
samples = h5read(destination_file, "meta/samples/geo_accession")
genes = h5read(destination_file, "meta/genes/genes")

# Identify columns to be extracted
sample_locations = which(samples %in% samp)

# extract gene expression from compressed data
expression = t(h5read(destination_file, "data/expression", index=list(sample_locations, 1:length(genes))))
H5close()
rownames(expression) = genes
colnames(expression) = samples[sample_locations]

# Print file
write.table(expression, file=extracted_expression_file, sep="\t", quote=FALSE, col.names=NA)
print(paste0("Expression file was created at ", getwd(), "/", extracted_expression_file))

