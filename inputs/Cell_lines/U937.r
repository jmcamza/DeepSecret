# R script to download selected samples
# Copy code and run on a local machine to initiate download

library("rhdf5")    # can be installed using Bioconductor

destination_file = "human_matrix_v10.h5"
extracted_expression_file = "U937_expression_matrix.tsv"
url = "https://s3.amazonaws.com/mssm-seq-matrix/human_matrix_v10.h5"

# Check if gene expression file was already downloaded, if not in current directory download file form repository
if(!file.exists(destination_file)){
    print("Downloading compressed gene expression matrix.")
    download.file(url, destination_file, quiet = FALSE, mode = 'wb')
}

# Selected samples to be extracted
samp = c("GSM1122324","GSM1122325","GSM2252973","GSM2252972","GSM2252971","GSM1410590","GSM1410582","GSM1410587","GSM1410591","GSM1410588","GSM1410592","GSM1410586","GSM1410581","GSM1410585","GSM1410589","GSM1410583","GSM1410584","GSM2046138","GSM2046136","GSM2046135","GSM2046137","GSM2324267","GSM3130946","GSM3130947","GSM3130948","GSM3130949","GSM3130950","GSM3130951","GSM3712986","GSM3261836","GSM3261837",
"GSM3261838","GSM3261839","GSM3261840","GSM3261841","GSM3261842","GSM3261843","GSM3261844","GSM3261845","GSM3261846","GSM3261847","GSM3261848","GSM3261849","GSM3261850","GSM3261851","GSM3261852","GSM3261853","GSM3261854","GSM3261855","GSM3261856","GSM3261857","GSM3261858","GSM3261859","GSM3261860","GSM3261861","GSM3261862","GSM3261863","GSM3852199","GSM3852200","GSM3852201","GSM3852202",
"GSM3852203","GSM3852204","GSM3852205","GSM3852206","GSM3852207","GSM4222553","GSM4222554","GSM4222555","GSM4222556","GSM4222557","GSM4222558","GSM4222559","GSM3712946","GSM3712947","GSM3712948","GSM3712949","GSM3712950","GSM3712951","GSM3712952","GSM3712953","GSM3712954","GSM3712955","GSM3712956","GSM3712957","GSM3712958","GSM3712959","GSM3712960","GSM3712961","GSM3712962","GSM3712963",
"GSM3712964","GSM3712965","GSM3712966","GSM3712967","GSM3712968","GSM3712969","GSM3712970","GSM3712971","GSM3712972","GSM3712973","GSM3712974","GSM3712975","GSM3712976","GSM3712977","GSM3712978","GSM3712979","GSM3712980","GSM3712981","GSM2975728","GSM2975729","GSM2975730","GSM2975731","GSM2975732","GSM2975733","GSM2975734","GSM2975735","GSM2975736","GSM2975737","GSM2975738","GSM2975739",
"GSM2975740","GSM2975741","GSM2975742","GSM4230607","GSM4230608","GSM4230609","GSM4230610","GSM4230611","GSM4230612","GSM4230613","GSM4230614","GSM4230617","GSM4230618","GSM3972674","GSM3972675","GSM3972676","GSM4615698","GSM4615699","GSM4615700","GSM4615701","GSM4615702","GSM4615703","GSM4615704","GSM4615705","GSM4615706","GSM4615707","GSM4615708","GSM4615709","GSM4634993","GSM4634994",
"GSM4634995","GSM4634996","GSM4634997","GSM4634998","GSM4634999","GSM4635000","GSM4635001","GSM4635003","GSM4635004","GSM4635005","GSM4635006","GSM4635007","GSM4635008","GSM4635009","GSM4635010","GSM4635011","GSM4635012","GSM4635013","GSM4635014","GSM4635015","GSM4635016","GSM4635017","GSM4635018","GSM4635019","GSM4635020","GSM2871534","GSM2871535","GSM2871536","GSM2871537","GSM2871538",
"GSM2871539","GSM2871540","GSM2871541","GSM2871542","GSM2871543","GSM2871544","GSM2871545","GSM2871546","GSM2871547","GSM2871548","GSM2871549","GSM3827195","GSM3827196","GSM3827197","GSM3827198","GSM3827199","GSM3827200","GSM3827201","GSM3827202","GSM3827203","GSM4586419","GSM4586420","GSM4586421","GSM4586422","GSM4586423","GSM4586424","GSM4979754","GSM4979755","GSM4979756","GSM4979757",
"GSM4979758","")

# Retrieve information from compressed data
samples = h5read(destination_file, "meta/samples/geo_accession")
genes = h5read(destination_file, "meta/genes/genes")

# Identify columns to be extracted
sample_locations = which(samples %in% samp)

# extract gene expression from compressed data
expression = t(h5read(destination_file, "data/expression", index=list(sample_locations, 1:length(genes))))
H5close()
rownames(expression) = genes
colnames(expression) = samples[sample_locations]

# Print file
write.table(expression, file=extracted_expression_file, sep="\t", quote=FALSE, col.names=NA)
print(paste0("Expression file was created at ", getwd(), "/", extracted_expression_file))

