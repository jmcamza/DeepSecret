# R script to download selected samples
# Copy code and run on a local machine to initiate download

library("rhdf5")    # can be installed using Bioconductor

destination_file = "human_matrix_v10.h5"
extracted_expression_file = "PC3_expression_matrix.tsv"
url = "https://s3.amazonaws.com/mssm-seq-matrix/human_matrix_v10.h5"

# Check if gene expression file was already downloaded, if not in current directory download file form repository
if(!file.exists(destination_file)){
    print("Downloading compressed gene expression matrix.")
    download.file(url, destination_file, quiet = FALSE, mode = 'wb')
}

# Selected samples to be extracted
samp = c("GSM1173130","GSM1185158","GSM1185152","GSM1173128","GSM1173129","GSM1185153","GSM1185149","GSM1185157","GSM1173131","GSM1185155","GSM1185159","GSM1173127","GSM1185150","GSM1173126","GSM1173124","GSM1173123","GSM1185154","GSM1185156","GSM1173125","GSM1185151","GSM1173122","GSM1185160","GSM1294148","GSM1294150","GSM1294151","GSM1826455","GSM1826458","GSM1294146","GSM1294149","GSM1294152","GSM1826457",
"GSM1294147","GSM1294145","GSM1826459","GSM1826454","GSM2130699","GSM2130694","GSM2130695","GSM2130698","GSM1294153","GSM1826456","GSM1574296","GSM1574295","GSM2072541","GSM2072542","GSM1374123","GSM1374124","GSM1374125","GSM1374126","GSM2398407","GSM2398403","GSM2398405","GSM2398404","GSM2398406","GSM2398402","GSM1564103","GSM1564104","GSM1564105","GSM1564106","GSM2858920","GSM2858921",
"GSM2858922","GSM2858923","GSM2858924","GSM2858925","GSM2858926","GSM2858927","GSM2858928","GSM2858929","GSM2858930","GSM2628146","GSM2628147","GSM2628148","GSM2628149","GSM2628150","GSM2628151","GSM2817829","GSM2817830","GSM2817831","GSM2817838","GSM2817839","GSM2817840","GSM3101280","GSM3101281","GSM3101282","GSM3048092","GSM3048095","GSM2982223","GSM2982224","GSM2982225","GSM2982226",
"GSM2982228","GSM3140750","GSM3140751","GSM3140752","GSM3140753","GSM3140754","GSM3140755","GSM3430668","GSM3430669","GSM3430670","GSM3430677","GSM3430678","GSM3430679","GSM3053696","GSM3053697","GSM3053698","GSM3544644","GSM3544645","GSM3544646","GSM3544647","GSM3612783","GSM3612784","GSM3612785","GSM3612786","GSM3612787","GSM3612788","GSM3612789","GSM3612790","GSM3612791","GSM3612792",
"GSM3612793","GSM3612794","GSM3612795","GSM3612796","GSM3612797","GSM3612798","GSM3612799","GSM3612800","GSM3178702","GSM3178703","GSM3178704","GSM3377436","GSM3377437","GSM3377438","GSM3097221","GSM3097222","GSM3097233","GSM3097234","GSM3097235","GSM3097236","GSM3097237","GSM3097238","GSM3097239","GSM3145517","GSM3145518","GSM3145519","GSM3145520","GSM3145521","GSM3145522","GSM3145523",
"GSM3145524","GSM3178701","GSM3692965","GSM3692966","GSM3692967","GSM3692968","GSM3692969","GSM3692970","GSM3692971","GSM3692972","GSM3692973","GSM3692974","GSM3692975","GSM3692976","GSM3692977","GSM3692978","GSM3692979","GSM3692980","GSM3692981","GSM3692982","GSM3316232","GSM3316233","GSM3316234","GSM3316235","GSM3316236","GSM3316237","GSM3316238","GSM3316239","GSM3673920","GSM3673921",
"GSM3673922","GSM4030435","GSM4030436","GSM4030437","GSM4030438","GSM4030439","GSM4030440","GSM4037014","GSM4037015","GSM4037016","GSM4037017","GSM4037018","GSM4037019","GSM3428944","GSM3428945","GSM3428946","GSM3428947","GSM3428948","GSM3428949","GSM4097573","GSM4097574","GSM4097575","GSM4097576","GSM4097577","GSM4097578","GSM4097579","GSM4097580","GSM4097581","GSM4097582","GSM4097583",
"GSM4097584","GSM4097585","GSM4097586","GSM4097587","GSM4097588","GSM4097589","GSM4097590","GSM4097591","GSM4097592","GSM4097593","GSM4097594","GSM4097595","GSM4097596","GSM2753360","GSM2753361","GSM2753362","GSM2753363","GSM2753364","GSM2753365","GSM2753366","GSM2753367","GSM2753368","GSM2753369","GSM3119600","GSM3119601","GSM3119602","GSM3119603","GSM3119604","GSM3119605","GSM3245104",
"GSM3245105","GSM3245106","GSM3245107","GSM3245108","GSM3245109","GSM3590973","GSM3590974","GSM3590975","GSM3590976","GSM3908717","GSM3908718","GSM3908719","GSM3908720","GSM3908721","GSM3908722","GSM3908723","GSM3908724","GSM3908725","GSM3908726","GSM3908727","GSM3908728","GSM3935998","GSM3935999","GSM3936000","GSM3936001","GSM4083489","GSM4083490","GSM4083491","GSM2293532","GSM2293533",
"GSM2293534","GSM2293535","GSM2293536","GSM2293537","GSM3263108","GSM3263109","GSM3263110","GSM3263111","GSM3263112","GSM3263113","GSM3302721","GSM3302722","GSM3302723","GSM3302724","GSM3302725","GSM3302726","GSM3308137","GSM3308138","GSM3315359","GSM3330365","GSM3330366","GSM3330367","GSM3330368","GSM3330369","GSM3330370","GSM3358217","GSM3358218","GSM3358219","GSM3358220","GSM3358221",
"GSM3358222","GSM4161596","GSM4161597","GSM4161598","GSM4161599","GSM4161600","GSM4161601","GSM4161602","GSM4161603","GSM4161604","GSM4161605","GSM4161606","GSM4161607","GSM4161608","GSM4161609","GSM4161610","GSM4161611","GSM4161612","GSM4161613","GSM4161614","GSM4161615","GSM4161616","GSM4161617","GSM4161618","GSM4161619","GSM4161620","GSM4161621","GSM4161622","GSM4161623","GSM4161624",
"GSM4161625","GSM4161626","GSM4161627","GSM4161628","GSM4161629","GSM4161630","GSM4161631","GSM4161632","GSM4161633","GSM4161634","GSM4161635","GSM4161636","GSM4161637","GSM4161638","GSM4161639","GSM4161640","GSM4161641","GSM4161642","GSM4161643","GSM4161644","GSM4161645","GSM4161646","GSM4161647","GSM4161648","GSM4161649","GSM4161650","GSM4161651","GSM4161652","GSM4161653","GSM4161654",
"GSM4161655","GSM4161656","GSM4161657","GSM4161658","GSM4161659","GSM4161660","GSM4161661","GSM4161662","GSM4161663","GSM4161664","GSM4161665","GSM4161666","GSM4161667","GSM4161668","GSM4161669","GSM4161670","GSM4161671","GSM4161672","GSM4161673","GSM4161674","GSM4161675","GSM4161676","GSM4161677","GSM4161678","GSM4161679","GSM4161680","GSM4161681","GSM4161682","GSM4161683","GSM4161684",
"GSM4161685","GSM4161686","GSM4161687","GSM4161688","GSM4161689","GSM4161690","GSM4161692","GSM4161693","GSM4161694","GSM4161695","GSM4161696","GSM4161697","GSM4161698","GSM4161699","GSM4161700","GSM4161701","GSM4161702","GSM4161703","GSM4161704","GSM4161705","GSM4161706","GSM4161707","GSM4161708","GSM4161709","GSM4161710","GSM4161711","GSM4161712","GSM4161713","GSM4161714","GSM4161715",
"GSM4161716","GSM4161717","GSM4161718","GSM4161719","GSM4161720","GSM4161721","GSM4161722","GSM4161723","GSM4161724","GSM4161725","GSM4161726","GSM4161727","GSM4161728","GSM4161729","GSM4161730","GSM4161731","GSM4161732","GSM4161733","GSM4161734","GSM4161735","GSM4161736","GSM4161737","GSM4161738","GSM4161739","GSM4161740","GSM4161741","GSM4161742","GSM4161743","GSM4161744","GSM4161745",
"GSM4161746","GSM4161747","GSM4161748","GSM4161749","GSM4161750","GSM4161751","GSM4161752","GSM4161753","GSM4161754","GSM4161755","GSM4161756","GSM4161757","GSM4161758","GSM4161759","GSM4161760","GSM4161761","GSM4161762","GSM4161763","GSM4161764","GSM4161765","GSM4161766","GSM4161767","GSM4161768","GSM4161769","GSM4161770","GSM4161771","GSM4161772","GSM4161773","GSM4161774","GSM4161775",
"GSM4162785","GSM4209423","GSM4209424","GSM3673767","GSM3673768","GSM3673769","GSM3673770","GSM3673771","GSM3673772","GSM3946402","GSM3946403","GSM3946404","GSM3946405","GSM4104513","GSM4104514","GSM4150527","GSM4150528","GSM4150529","GSM4150530","GSM4150531","GSM4150532","GSM4150533","GSM4150534","GSM4150535","GSM4150536","GSM4150537","GSM4150538","GSM4259672","GSM4259673","GSM4259674",
"GSM4259675","GSM4259676","GSM4259677","GSM2483498","GSM2483499","GSM2483500","GSM3138390","GSM3138391","GSM3138392","GSM3138393","GSM3138396","GSM3138398","GSM3138399","GSM3138400","GSM3138402","GSM3138403","GSM3138404","GSM3138405","GSM3138406","GSM3138407","GSM3138408","GSM3138409","GSM3138410","GSM3768268","GSM3768269","GSM3768270","GSM3768272","GSM3768273","GSM4117371","GSM4117373",
"GSM4142995","GSM4142997","GSM4339823","GSM4339824","GSM4339825","GSM4339826","GSM4339827","GSM4339828","GSM4339829","GSM4339830","GSM4339831","GSM4339832","GSM4339833","GSM4339834","GSM4339835","GSM4339836","GSM4339837","GSM4339838","GSM4339839","GSM4339840","GSM4339841","GSM4339842","GSM4339843","GSM4339844","GSM4339845","GSM4339846","GSM4486187","GSM4491270","GSM4491271","GSM4491272",
"GSM4491273","GSM4491274","GSM4491275","GSM4872945","GSM4872946","GSM5062155","GSM5062156","GSM5150641","GSM5150642","GSM5150643","GSM5150644","GSM5150645","GSM5330751","GSM5460875","GSM5460876","")

# Retrieve information from compressed data
samples = h5read(destination_file, "meta/samples/geo_accession")
genes = h5read(destination_file, "meta/genes/genes")

# Identify columns to be extracted
sample_locations = which(samples %in% samp)

# extract gene expression from compressed data
expression = t(h5read(destination_file, "data/expression", index=list(sample_locations, 1:length(genes))))
H5close()
rownames(expression) = genes
colnames(expression) = samples[sample_locations]

# Print file
write.table(expression, file=extracted_expression_file, sep="\t", quote=FALSE, col.names=NA)
print(paste0("Expression file was created at ", getwd(), "/", extracted_expression_file))

