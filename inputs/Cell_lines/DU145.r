# R script to download selected samples
# Copy code and run on a local machine to initiate download

library("rhdf5")    # can be installed using Bioconductor

destination_file = "human_matrix_v10.h5"
extracted_expression_file = "DU145_expression_matrix.tsv"
url = "https://s3.amazonaws.com/mssm-seq-matrix/human_matrix_v10.h5"

# Check if gene expression file was already downloaded, if not in current directory download file form repository
if(!file.exists(destination_file)){
    print("Downloading compressed gene expression matrix.")
    download.file(url, destination_file, quiet = FALSE, mode = 'wb')
}

# Selected samples to be extracted
samp = c("GSM1423448","GSM1423441","GSM1830022","GSM1423444","GSM1423447","GSM1423443","GSM1830016","GSM1830023","GSM1830018","GSM1423440","GSM1423445","GSM1830021","GSM1830017","GSM1423442","GSM1423446","GSM1830019","GSM1830020","GSM2461421","GSM2461420","GSM2461419","GSM2461422","GSM2187265","GSM2187266","GSM2187267","GSM2187268","GSM2187269","GSM2187270","GSM3032426","GSM3032427","GSM3032428","GSM3032429",
"GSM3032431","GSM3032434","GSM3032435","GSM3032436","GSM3032437","GSM3544640","GSM3544641","GSM3544642","GSM3544643","GSM3612765","GSM3612766","GSM3612767","GSM3612768","GSM3612769","GSM3612770","GSM3612771","GSM3612772","GSM3612773","GSM3612774","GSM3612775","GSM3612776","GSM3612777","GSM3612778","GSM3612779","GSM3612780","GSM3612781","GSM3612782","GSM3428950","GSM3428951","GSM3428952",
"GSM3428953","GSM3428954","GSM3428955","GSM3567191","GSM3567192","GSM3567193","GSM3567194","GSM3936002","GSM3936003","GSM3936004","GSM3936005","GSM3936006","GSM3936007","GSM3936008","GSM3936009","GSM3263114","GSM3263115","GSM3263116","GSM3263117","GSM3263118","GSM3263119","GSM3424011","GSM3424012","GSM4161452","GSM4161453","GSM4161454","GSM4161455","GSM4161456","GSM4161457","GSM4161458",
"GSM4161459","GSM4161460","GSM4161461","GSM4161462","GSM4161463","GSM4161464","GSM4161465","GSM4161466","GSM4161467","GSM4161468","GSM4161469","GSM4161470","GSM4161471","GSM4161472","GSM4161473","GSM4161474","GSM4161475","GSM4161476","GSM4161477","GSM4161478","GSM4161479","GSM4161481","GSM4161482","GSM4161483","GSM4161484","GSM4161485","GSM4161486","GSM4161488","GSM4161489","GSM4161490",
"GSM4161491","GSM4161492","GSM4161493","GSM4161494","GSM4161495","GSM4161496","GSM4161497","GSM4161498","GSM4161499","GSM4161500","GSM4161501","GSM4161502","GSM4161503","GSM4161504","GSM4161505","GSM4161506","GSM4161507","GSM4161508","GSM4161509","GSM4161510","GSM4161511","GSM4161512","GSM4161513","GSM4161514","GSM4161515","GSM4161516","GSM4161517","GSM4161518","GSM4161519","GSM4161520",
"GSM4161521","GSM4161523","GSM4161524","GSM4161525","GSM4161526","GSM4161527","GSM4161528","GSM4161529","GSM4161530","GSM4161531","GSM4161532","GSM4161533","GSM4161534","GSM4161535","GSM4161536","GSM4161537","GSM4161538","GSM4161539","GSM4161540","GSM4161541","GSM4161542","GSM4161543","GSM4161544","GSM4161545","GSM4161546","GSM4161547","GSM4161548","GSM4161549","GSM4161550","GSM4161551",
"GSM4161552","GSM4161553","GSM4161554","GSM4161555","GSM4161556","GSM4161557","GSM4161558","GSM4161559","GSM4161560","GSM4161561","GSM4161562","GSM4161563","GSM4161564","GSM4161565","GSM4161566","GSM4161567","GSM4161568","GSM4161569","GSM4161570","GSM4161571","GSM4161572","GSM4161573","GSM4161574","GSM4161575","GSM4161576","GSM4161577","GSM4161578","GSM4161579","GSM4161580","GSM4161581",
"GSM4161582","GSM4161583","GSM4161584","GSM4161585","GSM4161586","GSM4161587","GSM4161588","GSM4161589","GSM4161590","GSM4161591","GSM4161592","GSM4161593","GSM4161594","GSM4161595","GSM3673773","GSM3673774","GSM3673775","GSM3673776","GSM3673777","GSM3673778","GSM4161487","GSM3356493","GSM3356494","GSM3356495","GSM3356496","GSM4117279","GSM4117281","GSM4803680","GSM4803681","GSM4803682",
"GSM4803683","GSM4803684","GSM4803685","GSM4803686","GSM4803687","GSM4985184","GSM4985185","GSM4985186","GSM4985187","GSM4985188","GSM5062153","GSM5413147","GSM5413148","GSM5413149","GSM5413150","GSM5413152","GSM5413153","GSM5413154","GSM5413163","GSM5413164","GSM5413165","GSM5413166","GSM5413167","GSM5413168","GSM5413170","GSM5413172","GSM5413173","GSM5413174","GSM5430294","GSM5430296",
"GSM5430302","GSM5430304","GSM5430306","GSM5430310","GSM5430312","GSM5430314","GSM5430318","GSM5430322","GSM5430326","GSM5430332","GSM5430334","GSM5430338","GSM5430340","GSM5436575","GSM5436576","GSM5436577","GSM5436578","GSM5436579","GSM5436580","GSM5436581","GSM5436582","GSM5436583","GSM5436584","GSM5436585","GSM5436586","GSM5436587","GSM5436588","GSM5436589","GSM5436590","GSM5436591",
"GSM5436592","GSM5436593","GSM5436594","GSM5436595","GSM5436596","GSM5436597","GSM5436598","GSM5436599","GSM5436600","GSM5436601","GSM5436602","GSM5436603","GSM5436604","GSM5436605","GSM5436606","GSM5436607","GSM5436608","GSM5436609","GSM5436610","")

# Retrieve information from compressed data
samples = h5read(destination_file, "meta/samples/geo_accession")
genes = h5read(destination_file, "meta/genes/genes")

# Identify columns to be extracted
sample_locations = which(samples %in% samp)

# extract gene expression from compressed data
expression = t(h5read(destination_file, "data/expression", index=list(sample_locations, 1:length(genes))))
H5close()
rownames(expression) = genes
colnames(expression) = samples[sample_locations]

# Print file
write.table(expression, file=extracted_expression_file, sep="\t", quote=FALSE, col.names=NA)
print(paste0("Expression file was created at ", getwd(), "/", extracted_expression_file))

