# R script to download selected samples
# Copy code and run on a local machine to initiate download

library("rhdf5")    # can be installed using Bioconductor

destination_file = "human_matrix_v10.h5"
extracted_expression_file = "Adipocyte_expression_matrix.tsv"
url = "https://s3.amazonaws.com/mssm-seq-matrix/human_matrix_v10.h5"

# Check if gene expression file was already downloaded, if not in current directory download file form repository
if(!file.exists(destination_file)){
    print("Downloading compressed gene expression matrix.")
    download.file(url, destination_file, quiet = FALSE, mode = 'wb')
}

# Selected samples to be extracted
samp = c("GSM1543669","GSM1543665","GSM1543670","GSM1543671","GSM1543666","GSM1543668","GSM1543667","GSM1546371","GSM1468493","GSM1468495","GSM1468494","GSM1468492","GSM1546372","GSM2072477","GSM2072476","GSM2386058","GSM2386059","GSM2386060","GSM2386061","GSM3028161","GSM3028162","GSM3028163","GSM2471158","GSM2471159","GSM2471160","GSM2471161","GSM2471162","GSM2559649","GSM2559650","GSM2559651","GSM2559652",
"GSM3028164","GSM3032918","GSM3032919","GSM3032920","GSM3032921","GSM3032922","GSM3032923","GSM1480370","GSM1480371","GSM1480372","GSM1480373","GSM1480374","GSM1480375","GSM1566740","GSM1566741","GSM1566742","GSM1566743","GSM1566744","GSM1566745","GSM1566746","GSM1566747","GSM1566748","GSM1566749","GSM1566750","GSM1566751","GSM1566752","GSM1566753","GSM1709930","GSM1709931","GSM1709932",
"GSM1709933","GSM1709934","GSM1709935","GSM1709936","GSM1709937","GSM3106312","GSM3106313","GSM3106314","GSM3106315","GSM3106316","GSM3106317","GSM3190950","GSM3190951","GSM3190952","GSM3190953","GSM3190954","GSM3190955","GSM3190956","GSM3190957","GSM3190958","GSM3190959","GSM3190960","GSM3190961","GSM3416650","GSM3416651","GSM3416652","GSM3416653","GSM3416654","GSM3416655","GSM3416656",
"GSM3416657","GSM3416658","GSM3416659","GSM3416660","GSM3416661","GSM2498225","GSM2498226","GSM2498227","GSM2498228","GSM2498229","GSM2498230","GSM3057748","GSM3057751","GSM3057755","GSM3057756","GSM3177920","GSM3177921","GSM3177922","GSM3177923","GSM3177924","GSM3177925","GSM3177926","GSM3177927","GSM3177928","GSM3177929","GSM3177930","GSM3177931","GSM3177932","GSM3177933","GSM3177934",
"GSM3177935","GSM3177936","GSM3177937","GSM3177938","GSM3177939","GSM3177940","GSM3177941","GSM3177942","GSM3177943","GSM3177944","GSM3177945","GSM3177946","GSM3177947","GSM3177948","GSM3177949","GSM3416384","GSM3416385","GSM3416386","GSM3416387","GSM3416388","GSM3416389","GSM3416390","GSM3416391","GSM3416392","GSM3416393","GSM3416394","GSM3416395","GSM3692196","GSM3692197","GSM3692198",
"GSM3692199","GSM3692200","GSM3692201","GSM3692202","GSM3692203","GSM3692204","GSM3692205","GSM3692206","GSM3692207","GSM3692208","GSM3692209","GSM3692210","GSM4029856","GSM4029857","GSM4029858","GSM4029859","GSM4029860","GSM4029861","GSM4029867","GSM4029868","GSM4029869","GSM4029870","GSM4029871","GSM4029872","GSM4029873","GSM4029874","GSM4029875","GSM4029876","GSM4029877","GSM4029882",
"GSM4029883","GSM4029884","GSM4029885","GSM4029862","GSM4029863","GSM4029864","GSM4029865","GSM4029866","GSM4029879","GSM4029880","GSM4029881","GSM2934427","GSM2934428","GSM2934429","GSM2934430","GSM3563556","GSM3669336","GSM3669337","GSM3669338","GSM3669340","GSM3669342","GSM3669343","GSM3669344","GSM3669346","GSM3669347","GSM3669348","GSM3669349","GSM3669350","GSM3669351","GSM3669352",
"GSM3669353","GSM3669354","GSM3669355","GSM3669356","GSM3669357","GSM3669360","GSM3669362","GSM3669363","GSM3669366","GSM3669367","GSM3669368","GSM3669369","GSM3669370","GSM4485409","GSM4485410","GSM4485411","GSM4485412","GSM4485413","GSM4485414","GSM4485415","GSM4485416","GSM4485417","GSM4485418","GSM4485419","GSM4485420","GSM4485421","GSM4485422","GSM4485423","GSM3669341","GSM3669345",
"GSM3669358","GSM3669359","GSM3669361","GSM3669364","GSM3669365","GSM2322564","GSM2322565","GSM2322566","GSM2322567","GSM2322568","GSM2322569","GSM3405950","GSM3405953","GSM3405956","GSM3405959","GSM3405962","GSM3701297","GSM3701298","GSM3701299","GSM3701300","GSM3701301","GSM3701302","GSM4117879","GSM4117880","GSM4117881","GSM4117882","GSM4117884","GSM4160276","GSM4160277","GSM4160280",
"GSM4160281","GSM4160293","GSM4557249","GSM4557252","GSM4559448","GSM4559449","GSM4559450","GSM4559452","GSM4559453","GSM4705991","GSM4705995","GSM4705996","GSM4705997","GSM4705998","GSM4705999","GSM4971448","GSM4971451","GSM4971452","GSM4971453","GSM4971454","GSM4971455","GSM4971456","GSM4971458","GSM4971459","GSM4971460","GSM4971461","GSM4971462","GSM4971463","GSM4971464","GSM4971465",
"GSM4971466","GSM4971467","GSM4971468","GSM4971472","GSM4971473","GSM4971474","GSM4971475","GSM4971479","GSM4971480","GSM4971481","GSM4971482","GSM4971483","GSM4971485","GSM4971486","GSM4971489","GSM4971490","GSM4971492","GSM4971493","GSM5137772","GSM5137773","GSM5137774","GSM5137775","GSM5137780","GSM5137781","GSM5137782","GSM5137783","GSM5137784","GSM5137788","GSM5137789","GSM5137790",
"GSM5137791","GSM5137792","GSM5137796","GSM5137797","GSM5137798","GSM5137799","GSM5137800","GSM5137804","GSM5137805","GSM5137806","GSM5137807","GSM5137808","GSM5137812","GSM5137813","GSM5137814","GSM5137815","GSM5137816","GSM5137820","GSM5137821","GSM5137822","GSM5137823","GSM5137824","GSM5137829","GSM5137830","GSM5137831","GSM5137832","GSM5137833","GSM5137834","GSM5137835","GSM5137837",
"GSM5137838","GSM5137839","GSM5137840","GSM5137841","GSM5137842","GSM5137843","GSM5137844","GSM5266995","GSM5266996","GSM5266997","GSM5266998","GSM5267000","GSM5267115","GSM5267117","GSM5267118","GSM5571784","GSM5571785","GSM5571786","GSM5571787","GSM5571788","GSM5571789","GSM5571790","GSM5571792","GSM5571794","GSM5571796","GSM5571798","")

# Retrieve information from compressed data
samples = h5read(destination_file, "meta/samples/geo_accession")
genes = h5read(destination_file, "meta/genes/genes")

# Identify columns to be extracted
sample_locations = which(samples %in% samp)

# extract gene expression from compressed data
expression = t(h5read(destination_file, "data/expression", index=list(sample_locations, 1:length(genes))))
H5close()
rownames(expression) = genes
colnames(expression) = samples[sample_locations]

# Print file
write.table(expression, file=extracted_expression_file, sep="\t", quote=FALSE, col.names=NA)
print(paste0("Expression file was created at ", getwd(), "/", extracted_expression_file))

