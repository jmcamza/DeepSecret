# R script to download selected samples
# Copy code and run on a local machine to initiate download

library("rhdf5")    # can be installed using Bioconductor

destination_file = "human_matrix_v10.h5"
extracted_expression_file = "Astrocyte_expression_matrix.tsv"
url = "https://s3.amazonaws.com/mssm-seq-matrix/human_matrix_v10.h5"

# Check if gene expression file was already downloaded, if not in current directory download file form repository
if(!file.exists(destination_file)){
    print("Downloading compressed gene expression matrix.")
    download.file(url, destination_file, quiet = FALSE, mode = 'wb')
}

# Selected samples to be extracted
samp = c("GSM1521785","GSM1521784","GSM1521786","GSM2179771","GSM2179767","GSM2179769","GSM2179768","GSM2072512","GSM2072511","GSM2179774","GSM2179770","GSM2179772","GSM2179773","GSM2251930","GSM2251928","GSM2251929","GSM2258357","GSM2258361","GSM2258356","GSM2258364","GSM2258362","GSM2258359","GSM2258360","GSM2258358","GSM2258363","GSM2654098","GSM2654097","GSM2654096","GSM2654099","GSM2288272","GSM2288273",
"GSM2288274","GSM2288275","GSM2288276","GSM2288277","GSM2288278","GSM2288279","GSM2288280","GSM2288281","GSM2288282","GSM2288283","GSM2747932","GSM2747933","GSM2747934","GSM2445426","GSM2124706","GSM2124707","GSM2373100","GSM2373101","GSM2373102","GSM2373103","GSM2373104","GSM2373105","GSM2373106","GSM2373107","GSM2373108","GSM2373109","GSM2373110","GSM2739764","GSM2739765","GSM2739766",
"GSM2739767","GSM2739768","GSM2739769","GSM2739770","GSM2739771","GSM2739772","GSM2927872","GSM2927873","GSM2927874","GSM2927875","GSM2927876","GSM2927877","GSM2927878","GSM2927879","GSM2927880","GSM2927881","GSM2927882","GSM2927883","GSM2927887","GSM2927888","GSM2927889","GSM2466369","GSM2751143","GSM2751144","GSM2751145","GSM2751146","GSM2751147","GSM2751148","GSM3228113","GSM3398127",
"GSM3398128","GSM3398129","GSM3398130","GSM3398131","GSM3398132","GSM3398133","GSM3176581","GSM3176582","GSM3176583","GSM3176584","GSM3176585","GSM3176586","GSM3176587","GSM3176588","GSM3394733","GSM3394734","GSM3394735","GSM3394736","GSM3394737","GSM3394738","GSM3394739","GSM3394740","GSM3394741","GSM3394742","GSM3394743","GSM3394744","GSM3394745","GSM3394746","GSM3394747","GSM3394748",
"GSM3394749","GSM3394750","GSM3394751","GSM3394752","GSM3400454","GSM3400455","GSM3400456","GSM3400457","GSM3400458","GSM3400459","GSM3400460","GSM3400461","GSM3400462","GSM3400463","GSM3400464","GSM3400465","GSM3400466","GSM3400467","GSM3400468","GSM3400469","GSM3400470","GSM3400471","GSM3400472","GSM3400473","GSM3400474","GSM3400475","GSM3400476","GSM3400477","GSM3400478","GSM3400479",
"GSM3400480","GSM3400481","GSM3400482","GSM3400483","GSM3400484","GSM3400485","GSM3400486","GSM3400487","GSM3400488","GSM3400489","GSM3400490","GSM3400491","GSM3400492","GSM3400493","GSM3400494","GSM3400495","GSM3400496","GSM3400497","GSM3400498","GSM3400499","GSM3400500","GSM3400501","GSM3244995","GSM3244996","GSM3244997","GSM3244998","GSM3244999","GSM3245000","GSM3245001","GSM3245002",
"GSM3245003","GSM3245004","GSM3245005","GSM3245006","GSM3314839","GSM3314840","GSM3314841","GSM3314842","GSM3314843","GSM3314844","GSM3314845","GSM3314846","GSM3314847","GSM3314848","GSM3314849","GSM3314850","GSM3314851","GSM3314852","GSM3314853","GSM3314854","GSM3430885","GSM3430886","GSM3430887","GSM3430888","GSM3430889","GSM3430890","GSM3430891","GSM3430892","GSM3430893","GSM3430894",
"GSM3430895","GSM3430896","GSM3430897","GSM3430898","GSM3430899","GSM3106842","GSM3106843","GSM3597694","GSM3597695","GSM3910342","GSM3910343","GSM3910344","GSM3910345","GSM3910346","GSM3910347","GSM3910348","GSM3910349","GSM3910350","GSM3910351","GSM3910352","GSM3910353","GSM4212779","GSM4212780","GSM4212781","GSM4212782","GSM4212783","GSM4212784","GSM4212785","GSM4212786","GSM4212787",
"GSM4212788","GSM4212789","GSM4212790","GSM3326079","GSM3326080","GSM3326081","GSM3326082","GSM3326083","GSM4116282","GSM4116284","GSM4116285","GSM4116286","GSM4116287","GSM4116288","GSM4116289","GSM4116290","GSM4116291","GSM4116292","GSM4116293","GSM4162577","GSM4162578","GSM4162579","GSM4162580","GSM4162581","GSM4162582","GSM4162583","GSM4162584","GSM4162585","GSM4162586","GSM4162587",
"GSM4162588","GSM4162589","GSM4162590","GSM4162591","GSM4238296","GSM4238297","GSM4238298","GSM4238299","GSM4505479","GSM4505480","GSM4505481","GSM4505482","GSM4505483","GSM4505484","GSM4505485","GSM4505486","GSM4505487","GSM4706243","GSM4706244","GSM4706245","GSM4706246","GSM4706247","GSM4706248","GSM4706249","GSM4706250","GSM4706251","GSM4706252","GSM4706253","GSM4706254","GSM4706255",
"GSM4706257","GSM4706258","GSM4706259","GSM4706260","GSM4706264","GSM4706265","GSM4706266","GSM4706256","GSM4818812","GSM4818813","GSM4818833","GSM4818834","GSM4818835","GSM4888564","GSM4888567","GSM3755362","GSM3755363","GSM3755364","GSM3755365","GSM3755366","GSM3755367","GSM3755368","GSM3755369","GSM3755370","GSM3755371","GSM4117521","GSM4117523","GSM4117524","GSM4117526","GSM4117527",
"GSM4117528","GSM4117529","GSM4117530","GSM4117531","GSM4117532","GSM4117533","GSM4117534","GSM4117535","GSM4117536","GSM4117537","GSM4117538","GSM4117539","GSM4117541","GSM4680724","GSM4680725","GSM4680726","GSM4680727","GSM4680728","GSM4680729","GSM4680730","GSM4680731","GSM4680732","GSM4680733","GSM4680734","GSM4680735","GSM4680736","GSM4680737","GSM4680738","GSM4680739","GSM4768900",
"GSM4768901","GSM4768902","GSM4768904","GSM4768905","GSM4768907","GSM4768908","GSM4768910","GSM4768911","GSM4768913","GSM4768914","GSM4768915","GSM4768916","GSM4768917","GSM4768918","GSM4768919","GSM4768920","GSM4768921","GSM4768922","GSM4768923","GSM4768924","GSM4768925","GSM4768926","GSM4768928","GSM4768929","GSM4768930","GSM4768932","GSM4859807","GSM4859808","GSM4859809","GSM4859810",
"GSM4859812","GSM4859813","GSM4964767","GSM4964768","GSM4964769","GSM4964770","GSM4964771","GSM4964772","GSM4964773","GSM4964774","GSM4964775","GSM4964776","GSM4964777","GSM4964778","GSM4964779","GSM4964780","GSM4964781","GSM4964782","GSM4964783","GSM4964784","GSM5067977","GSM5067978","GSM5067980","GSM5067981","GSM5067982","GSM5067983","GSM5067992","GSM5067993","GSM5067994","GSM5067995",
"GSM5067996","GSM5067997","GSM5067998","GSM5068000","GSM5068001","GSM5068003","GSM5068004","GSM5068005","GSM5068006","GSM5068007","GSM5068008","GSM5068009","GSM5068010","GSM5068011","GSM5068013","GSM5068014","GSM5068015","GSM5068016","GSM5068017","GSM5068018","GSM5068019","GSM5068020","GSM5068021","GSM5068022","GSM5068023","GSM5068024","GSM5068025","GSM5068026","GSM5068027","GSM5068028",
"GSM5068029","GSM5068030","GSM5068032","GSM5068033","GSM5068034","GSM5068035","GSM5068036","GSM5068037","GSM5068038","GSM5068039","GSM5068040","GSM5068041","GSM5068042","GSM5068043","GSM5068044","GSM5068045","GSM5068046","GSM5068047","GSM5068048","GSM5068049","GSM5068051","GSM5068052","GSM5068053","GSM5068054","GSM5068055","GSM5068056","GSM5068057","GSM5068058","GSM5068059","GSM5068060",
"GSM5068061","GSM5068062","GSM5068063","GSM5068064","GSM5068065","GSM5068066","GSM5068067","GSM5068068","GSM5068070","GSM5068071","GSM5073273","GSM5073278","GSM5086573","GSM5086574","GSM5086575","GSM5086576","GSM5086577","GSM5086578","GSM5086579","GSM5086580","GSM5086581","GSM5086582","GSM5086583","GSM5086584","GSM5086585","GSM5086586","GSM5086587","GSM5086588","GSM5086589","GSM5086590",
"GSM5086591","GSM5086592","GSM5240816","GSM5346158","GSM5369929","GSM5369930","GSM5436488","GSM5436491","GSM5436970","GSM5491636","GSM5526456","GSM5526457","GSM5526458","GSM5526459","GSM5526460","GSM5526461","GSM5526462","GSM5526463","GSM5526464","GSM5526467","GSM5526468","GSM5526473","GSM5526474","GSM5526475","GSM5526481","GSM5526482","GSM5526484","GSM5526485","GSM5526486","GSM5555556",
"GSM5555568","")

# Retrieve information from compressed data
samples = h5read(destination_file, "meta/samples/geo_accession")
genes = h5read(destination_file, "meta/genes/genes")

# Identify columns to be extracted
sample_locations = which(samples %in% samp)

# extract gene expression from compressed data
expression = t(h5read(destination_file, "data/expression", index=list(sample_locations, 1:length(genes))))
H5close()
rownames(expression) = genes
colnames(expression) = samples[sample_locations]

# Print file
write.table(expression, file=extracted_expression_file, sep="\t", quote=FALSE, col.names=NA)
print(paste0("Expression file was created at ", getwd(), "/", extracted_expression_file))

