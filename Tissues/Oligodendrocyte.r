# R script to download selected samples
# Copy code and run on a local machine to initiate download

library("rhdf5")    # can be installed using Bioconductor

destination_file = "human_matrix_v10.h5"
extracted_expression_file = "Oligodendrocyte_expression_matrix.tsv"
url = "https://s3.amazonaws.com/mssm-seq-matrix/human_matrix_v10.h5"

# Check if gene expression file was already downloaded, if not in current directory download file form repository
if(!file.exists(destination_file)){
    print("Downloading compressed gene expression matrix.")
    download.file(url, destination_file, quiet = FALSE, mode = 'wb')
}

# Selected samples to be extracted
samp = c("GSM1857485","GSM3162655","GSM3162656","GSM3162657","GSM3162658","GSM3162659","GSM3162660","GSM3162661","GSM3162662","GSM3162663","GSM3162664","GSM3162665","GSM3162666","GSM3162667","GSM3162668","GSM3162669","GSM3162670","GSM3162671","GSM3162672","GSM3162673","GSM3162675","GSM3162676","GSM3162677","GSM3162678","GSM3162679","GSM3162680","GSM3162681","GSM3162682","GSM3162683","GSM3162684","GSM3162685",
"GSM3162686","GSM3162687","GSM3162688","GSM3162689","GSM3162690","GSM3162691","GSM3162692","GSM3162693","GSM3162694","GSM3162695","GSM3162696","GSM3162697","GSM3162698","GSM3162699","GSM3162700","GSM3162701","GSM3162702","GSM3162703","GSM3162704","GSM3162705","GSM3162706","GSM3162707","GSM3162708","GSM3162709","GSM3162710","GSM3162711","GSM3162712","GSM3162713","GSM3162714","GSM3162715",
"GSM3162716","GSM3162717","GSM3162718","GSM3162719","GSM3162720","GSM3162721","GSM3162722","GSM3162723","GSM3162724","GSM3162725","GSM3162726","GSM3162727","GSM3162728","GSM3162729","GSM3162730","GSM3162731","GSM3162732","GSM3162733","GSM3162734","GSM3162735","GSM3162736","GSM3162737","GSM3162738","GSM3162739","GSM3162740","GSM3162741","GSM3162742","GSM3162743","GSM3162744","GSM3162745",
"GSM3162746","GSM3162747","GSM3162748","GSM3162749","GSM3162750","GSM3162751","GSM3162752","GSM3162753","GSM3162754","GSM3162755","GSM3162756","GSM3162757","GSM3162758","GSM3162759","GSM3162760","GSM3162761","GSM3162762","GSM3162763","GSM3162764","GSM3162765","GSM3162766","GSM3162767","GSM3162768","GSM3162769","GSM3162770","GSM3162771","GSM3162772","GSM3162773","GSM3162774","GSM3162775",
"GSM3162776","GSM3162777","GSM3162778","GSM3162779","GSM3162780","GSM3162781","GSM3162782","GSM3162784","GSM3162785","GSM3162786","GSM3162787","GSM3162788","GSM3162789","GSM3162790","GSM3162791","GSM3162792","GSM3162793","GSM3162794","GSM3162795","GSM3162796","GSM3162797","GSM3162798","GSM3162799","GSM3162800","GSM3162801","GSM3162802","GSM3162803","GSM3162804","GSM3162805","GSM3162806",
"GSM3162807","GSM3162808","GSM3162809","GSM3162810","GSM3162811","GSM3162812","GSM3162813","GSM3162814","GSM3162815","GSM3162816","GSM3162817","GSM3162818","GSM3162819","GSM3162820","GSM3162821","GSM3162822","GSM3162823","GSM3162824","GSM3162825","GSM3162826","GSM3162827","GSM3162828","GSM3162829","GSM3162830","GSM3162831","GSM3162832","GSM3162833","GSM3162834","GSM3162835","GSM3162836",
"GSM3162837","GSM3162838","GSM3162839","GSM3162840","GSM3162841","GSM3162842","GSM3162843","GSM3162844","GSM3162845","GSM3162846","GSM3162847","GSM3162848","GSM3162849","GSM3162850","GSM3162851","GSM3162852","GSM3162853","GSM3162854","GSM3162855","GSM3162856","GSM3162857","GSM3162858","GSM3162859","GSM3162860","GSM3162861","GSM3162862","GSM3162863","GSM3162864","GSM3162865","GSM3162866",
"GSM3162867","GSM3162868","GSM3162869","GSM3162870","GSM3162871","GSM3162872","GSM3162873","GSM3162874","GSM3162875","GSM3162876","GSM3162877","GSM3162878","GSM3162879","GSM3162880","GSM3162881","GSM3162882","GSM3162883","GSM3162884","GSM3162885","GSM3162886","GSM3162887","GSM3162888","GSM3162889","GSM3162890","GSM3162891","GSM3162892","GSM3162893","GSM3162894","GSM3162895","GSM3162896",
"GSM3162897","GSM3162898","GSM3162899","GSM3162900","GSM3162901","GSM3162902","GSM3162903","GSM3162904","GSM3162905","GSM3162906","GSM3162907","GSM3162908","GSM3162909","GSM3162910","GSM3162911","GSM3162912","GSM3162913","GSM3162914","GSM3162915","GSM3162916","GSM3162917","GSM3162918","GSM3162919","GSM3162920","GSM3162921","GSM3162922","GSM3162923","GSM3162924","GSM3162925","GSM3162926",
"GSM3162927","GSM3162928","GSM3162929","GSM3162930","GSM3162931","GSM3162932","GSM3162933","GSM3162934","GSM3162935","GSM3162936","GSM3162937","GSM3162938","GSM3162939","GSM3162940","GSM3162941","GSM3162942","GSM3162943","GSM3162944","GSM3162945","GSM3162946","GSM3162947","GSM3162948","GSM3162949","GSM3473952","GSM3473953","GSM3473954","GSM3473955","GSM3473956","GSM3473957","GSM3473958",
"GSM3473959","GSM3473960","GSM3305835","GSM3305836","GSM3305837","GSM4117512","GSM4117513","GSM4117514","")

# Retrieve information from compressed data
samples = h5read(destination_file, "meta/samples/geo_accession")
genes = h5read(destination_file, "meta/genes/genes")

# Identify columns to be extracted
sample_locations = which(samples %in% samp)

# extract gene expression from compressed data
expression = t(h5read(destination_file, "data/expression", index=list(sample_locations, 1:length(genes))))
H5close()
rownames(expression) = genes
colnames(expression) = samples[sample_locations]

# Print file
write.table(expression, file=extracted_expression_file, sep="\t", quote=FALSE, col.names=NA)
print(paste0("Expression file was created at ", getwd(), "/", extracted_expression_file))

