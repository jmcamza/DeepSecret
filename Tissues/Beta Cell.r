# R script to download selected samples
# Copy code and run on a local machine to initiate download

library("rhdf5")    # can be installed using Bioconductor

destination_file = "human_matrix_v10.h5"
extracted_expression_file = "Beta Cell_expression_matrix.tsv"
url = "https://s3.amazonaws.com/mssm-seq-matrix/human_matrix_v10.h5"

# Check if gene expression file was already downloaded, if not in current directory download file form repository
if(!file.exists(destination_file)){
    print("Downloading compressed gene expression matrix.")
    download.file(url, destination_file, quiet = FALSE, mode = 'wb')
}

# Selected samples to be extracted
samp = c("GSM1093237","GSM1093238","GSM1649211","GSM1649214","GSM1649193","GSM1649209","GSM1649192","GSM1649210","GSM1649213","GSM1649197","GSM1649195","GSM1649191","GSM1649196","GSM1649212","GSM1980055","GSM1980058","GSM1980057","GSM1980056","GSM1649194","GSM2574470","GSM2574471","GSM2574472","GSM2574473","GSM2574475","GSM2574476","GSM2574477","GSM2574478","GSM2574479","GSM2574484","GSM2574486","GSM2574488",
"GSM2574490","GSM2574491","GSM2574492","GSM2574494","GSM2574495","GSM2574497","GSM2574499","GSM2574501","GSM2574504","GSM2574506","GSM2574507","GSM2574508","GSM2574509","GSM2574512","GSM2574514","GSM2574515","GSM2574518","GSM2574522","GSM2574524","GSM2574525","GSM2574535","GSM2574536","GSM2574537","GSM2574538","GSM2574539","GSM2574541","GSM2574542","GSM2574543","GSM2574544","GSM2574545",
"GSM2574546","GSM2574548","GSM2574549","GSM2574551","GSM2574552","GSM2574555","GSM2574556","GSM2574558","GSM2574563","GSM2574564","GSM2574565","GSM2574566","GSM2574567","GSM2574568","GSM2574569","GSM2574570","GSM2574571","GSM2574572","GSM2574573","GSM2574574","GSM2574577","GSM2574578","GSM2574579","GSM2574584","GSM2574589","GSM2574590","GSM2574596","GSM2574597","GSM2574600","GSM2574606",
"GSM2574609","GSM2574610","GSM2574611","GSM2574612","GSM2574614","GSM2574615","GSM2574616","GSM2574624","GSM2574637","GSM2574654","GSM2574658","GSM2574666","GSM2574667","GSM2574668","GSM2574669","GSM2574670","GSM2574671","GSM2574672","GSM2574674","GSM2574676","GSM2574677","GSM2574678","GSM2574679","GSM2574680","GSM2574681","GSM2574682","GSM2574683","GSM2574684","GSM2574685","GSM2574688",
"GSM2574689","GSM2574690","GSM2574691","GSM3230057","GSM3230058","GSM3230059","GSM3230060","GSM3230061","GSM3230062","GSM3230063","GSM3230064","GSM2212890","GSM2212891","GSM2212892","GSM2212893","GSM2218791","GSM2218792","GSM2218793","GSM2218794","GSM2967463","GSM2967464","GSM2967465","GSM2967466","GSM2967467","GSM2967468","GSM2967469","GSM2967470","GSM4095104","GSM4095105","GSM4095106",
"GSM4095107","GSM4095108","GSM4095109","GSM4095110","GSM4095111","GSM3926177","GSM3926178","GSM3926179","GSM3926180","GSM3926181","GSM3926182","GSM3926183","GSM3926184","GSM3926185","GSM3926186","GSM3926187","GSM3926188","GSM4118625","GSM4118626","GSM4118629","GSM4118630","GSM4118633","GSM4118634","GSM4306162","GSM4306163","GSM4306164","GSM4306165","GSM4306166","GSM4306167","GSM4426445",
"GSM4426446","GSM4426447","GSM4426448","GSM4426449","GSM4426450","GSM4426451","GSM4426452","GSM4426453","GSM4426454","GSM4426455","GSM4426456","GSM4443954","GSM4443955","GSM4443956","GSM4443957","GSM4443958","GSM4443959","GSM4443960","GSM4443961","GSM4443962","GSM4443963","GSM4443964","GSM4443965","GSM4873774","GSM4873775","GSM4873776","GSM4873777","GSM4873780","")

# Retrieve information from compressed data
samples = h5read(destination_file, "meta/samples/geo_accession")
genes = h5read(destination_file, "meta/genes/genes")

# Identify columns to be extracted
sample_locations = which(samples %in% samp)

# extract gene expression from compressed data
expression = t(h5read(destination_file, "data/expression", index=list(sample_locations, 1:length(genes))))
H5close()
rownames(expression) = genes
colnames(expression) = samples[sample_locations]

# Print file
write.table(expression, file=extracted_expression_file, sep="\t", quote=FALSE, col.names=NA)
print(paste0("Expression file was created at ", getwd(), "/", extracted_expression_file))

